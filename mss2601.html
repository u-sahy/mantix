<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Expense Tracker</title>
    <link href="https://fonts.googleapis.com/css2?family=DM+Sans:wght@300;400;500;600;700&family=DM+Mono:wght@400;500&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://fonts.googleapis.com/css2?family=Material+Symbols+Outlined:opsz,wght,FILL,GRAD@24,400,0,0" />
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/Chart.js/3.9.1/chart.min.js"></script>
    <style>
        :root {
            --bg:         #f4f7fb;
            --surface:    #ffffff;
            --border:     #e2e8f2;
            --blue-1:     #1a3a7c;
            --blue-2:     #2563eb;
            --blue-3:     #3b82f6;
            --blue-light: #eff6ff;
            --blue-mid:   #dbeafe;
            --text:       #1e293b;
            --text-sub:   #64748b;
            --text-muted: #94a3b8;
            --gradient:   linear-gradient(135deg, #1a3a7c 0%, #2563eb 100%);
            --shadow-sm:  0 1px 3px rgba(26,58,124,0.08);
            --shadow-md:  0 4px 16px rgba(26,58,124,0.12);
        }
        * { margin: 0; padding: 0; box-sizing: border-box; }
        body { font-family: 'DM Sans', sans-serif; background: var(--bg); min-height: 100vh; padding-bottom: 80px; color: var(--text); }
        #loginPage { display: flex; justify-content: center; align-items: center; min-height: 100vh; padding: 20px; background: var(--gradient); }
        .login-container { background: var(--surface); border-radius: 20px; padding: 40px; box-shadow: 0 10px 40px rgba(0,0,0,0.1); max-width: 400px; width: 100%; border: 2px solid var(--border); }
        .login-container h1 { text-align: center; color: var(--blue-1); margin-bottom: 30px; font-size: 2rem; display: flex; align-items: center; justify-content: center; gap: 10px; }
        .login-form-group { margin-bottom: 20px; }
        .login-form-group label { display: block; margin-bottom: 8px; font-weight: 500; color: var(--text-sub); }
        .login-form-group input { width: 100%; padding: 12px; background: var(--surface); border: 2px solid var(--border); border-radius: 8px; font-size: 16px; transition: all 0.3s ease; color: var(--text); font-family: 'DM Sans', sans-serif; }
        .login-form-group input:focus { outline: none; border-color: var(--blue-3); box-shadow: 0 0 0 3px rgba(59,130,246,0.12); }
        .btn-login { width: 100%; padding: 15px; background: var(--gradient); color: white; border: none; border-radius: 10px; font-size: 18px; font-weight: 600; cursor: pointer; transition: all 0.3s ease; font-family: 'DM Sans', sans-serif; display: flex; align-items: center; justify-content: center; gap: 8px; }
        .btn-login:hover { transform: translateY(-2px); box-shadow: 0 6px 20px rgba(37,99,235,0.35); }
        .btn-login:disabled { opacity: 0.6; cursor: not-allowed; transform: none; }
        .error-message { color: #dc2626; text-align: center; margin-top: 15px; display: none; background: #fef2f2; border: 1.5px solid #fecaca; border-radius: 8px; padding: 10px; font-size: 14px; }
        .login-links { margin-top: 12px; display: flex; flex-direction: column; gap: 4px; align-items: flex-end; }
        .login-links a { font-size: 0.83rem; color: var(--blue-2); text-decoration: none; font-weight: 500; }
        .login-links a:hover { text-decoration: underline; }
        .spinner-sm { width: 18px; height: 18px; border: 2.5px solid rgba(255,255,255,0.4); border-top-color: white; border-radius: 50%; animation: loginSpin 0.8s linear infinite; display: none; }
        @keyframes loginSpin { to { transform: rotate(360deg); } }
        #appContainer { display: none; max-width: 1200px; margin: 0 auto; padding: 20px; }
        .bottom-nav { position: fixed; bottom: 20px; left: 50%; transform: translateX(-50%); background: var(--surface); box-shadow: 0 8px 32px rgba(26,58,124,0.12); display: flex; border-radius: 20px; padding: 8px; gap: 5px; z-index: 1000; border: 2px solid var(--border); min-width: 340px; max-width: 560px; width: auto; }
        .nav-item { display: flex; flex-direction: column; align-items: center; padding: 12px 16px; cursor: pointer; transition: all 0.3s ease; border-radius: 15px; flex: 1; min-width: 70px; background: transparent; position: relative; overflow: hidden; }
        .nav-item:hover { background: var(--blue-light); }
        .nav-item.active { background: var(--gradient); box-shadow: 0 4px 15px rgba(37,99,235,0.25); transform: translateY(-2px); }
        .nav-item .material-symbols-outlined { font-size: 24px; margin-bottom: 4px; transition: all 0.3s ease; color: var(--text-muted); }
        .nav-item.active .material-symbols-outlined { color: white; transform: scale(1.1); }
        .nav-item span:not(.material-symbols-outlined) { font-size: 12px; font-weight: 500; transition: all 0.3s ease; color: var(--text-muted); }
        .nav-item.active span:not(.material-symbols-outlined) { color: white; font-weight: 600; }
        .page { display: none; animation: fadeIn 0.3s ease; }
        .page.active { display: block; }
        @keyframes fadeIn { from { opacity: 0; transform: translateY(10px); } to { opacity: 1; transform: translateY(0); } }
        .container { background: var(--surface); border-radius: 20px; padding: 30px; box-shadow: 0 10px 40px rgba(26,58,124,0.08); margin-top: 20px; border: 2px solid var(--border); }
        .page-title { text-align: center; color: var(--blue-1); font-size: 2rem; margin-bottom: 30px; padding-bottom: 15px; border-bottom: 3px solid var(--blue-mid); display: flex; align-items: center; justify-content: center; gap: 10px; }
        .form-group { margin-bottom: 20px; }
        .form-group label { display: block; margin-bottom: 8px; font-weight: 500; color: var(--text-sub); }
        .form-group input, .form-group select { width: 100%; padding: 12px; background: var(--surface); border: 2px solid var(--border); border-radius: 8px; font-size: 16px; transition: all 0.3s ease; color: var(--text); font-family: 'DM Sans', sans-serif; }
        .form-group input:focus, .form-group select:focus { outline: none; border-color: var(--blue-3); box-shadow: 0 0 0 3px rgba(59,130,246,0.12); }
        .btn-submit { width: 100%; padding: 15px; background: var(--gradient); color: white; border: none; border-radius: 10px; font-size: 18px; font-weight: 600; cursor: pointer; transition: all 0.3s ease; font-family: 'DM Sans', sans-serif; }
        .btn-submit:hover { transform: translateY(-2px); box-shadow: 0 6px 20px rgba(37,99,235,0.35); }
        .btn-submit:disabled { opacity: 0.6; cursor: not-allowed; }
        .admin-unlock { background: #fef3c7; border: 2px solid #f59e0b; border-radius: 10px; padding: 20px; margin-bottom: 20px; text-align: center; }
        .admin-unlock h3 { color: #92400e; margin-bottom: 15px; display: flex; align-items: center; justify-content: center; gap: 10px; }
        .unlock-input-group { display: flex; gap: 10px; max-width: 400px; margin: 0 auto; }
        .unlock-input-group input { flex: 1; padding: 10px; background: white; border: 2px solid #f59e0b; border-radius: 8px; color: var(--text); font-family: 'DM Sans', sans-serif; }
        .btn-unlock { padding: 10px 20px; background: #f59e0b; color: white; border: none; border-radius: 8px; font-weight: 600; cursor: pointer; transition: all 0.3s ease; font-family: 'DM Sans', sans-serif; }
        .btn-unlock:hover { background: #d97706; }
        .main-balance-card { background: var(--gradient); padding: 30px; border-radius: 15px; text-align: center; margin-bottom: 30px; color: white; position: relative; overflow: hidden; }
        .main-balance-card::before { content: ''; position: absolute; top: -50%; left: -50%; width: 200%; height: 200%; background: linear-gradient(45deg, transparent, rgba(255,255,255,0.07), transparent); animation: shimmer 3s infinite; }
        @keyframes shimmer { 0% { transform: translateX(-100%) translateY(-100%) rotate(45deg); } 100% { transform: translateX(100%) translateY(100%) rotate(45deg); } }
        .main-balance-lbl { font-size: 18px; margin-bottom: 10px; opacity: 0.9; }
        .main-balance-val { font-size: 48px; font-weight: 700; position: relative; z-index: 1; }
        .filter-container { background: var(--bg); padding: 20px; border-radius: 10px; margin-bottom: 20px; border: 2px solid var(--border); }
        .filter-controls { display: flex; gap: 20px; flex-wrap: wrap; }
        .filter-select-group { flex: 1; min-width: 200px; }
        .filter-select-group label { display: block; margin-bottom: 5px; font-weight: 500; color: var(--text-sub); }
        .filter-select-group select { width: 100%; padding: 10px; background: var(--surface); border: 2px solid var(--border); border-radius: 8px; font-size: 16px; color: var(--text); font-family: 'DM Sans', sans-serif; }
        .action-icons { display: flex; gap: 10px; padding-bottom: 10px; }
        .icon-btn { background: var(--surface); border: 2px solid var(--border); padding: 8px; border-radius: 50%; cursor: pointer; display: flex; align-items: center; justify-content: center; transition: all 0.3s ease; color: var(--blue-1); }
        .icon-btn:hover { background: var(--blue-1); color: white; border-color: var(--blue-1); transform: scale(1.1); }
        .table-wrapper { overflow-x: auto; margin-bottom: 30px; border-radius: 10px; border: 2px solid var(--border); }
        .recent-table { width: 100%; border-collapse: collapse; background: var(--surface); }
        .recent-table thead { background: var(--bg); }
        .recent-table th { padding: 15px; text-align: left; font-weight: 600; color: var(--blue-1); border-bottom: 2px solid var(--border); }
        .recent-table td { padding: 15px; border-bottom: 1px solid var(--border); color: var(--text-sub); }
        .date-col { width: 100px; }
        .amount-col { width: 120px; text-align: right; font-weight: 500; }
        .action-col { width: 60px; text-align: center; }
        .green { color: #059669 !important; }
        .red { color: #dc2626 !important; }
        #monthly-container { margin-bottom: 30px; }
        .month-section { margin-bottom: 25px; }
        .month-header { background: var(--gradient); color: white; padding: 15px 20px; border-radius: 10px 10px 0 0; font-size: 18px; font-weight: 600; border: 2px solid var(--blue-2); border-bottom: none; }
        .month-card { background: var(--surface); border-radius: 0 0 10px 10px; overflow: hidden; border: 2px solid var(--border); border-top: none; }
        .month-summary-table { border-collapse: collapse; background: var(--surface); margin: 20px; border-radius: 8px; overflow: hidden; border: 1px solid var(--border); width: calc(100% - 40px); }
        .month-summary-table th { background: var(--blue-1); color: white; padding: 15px; text-align: center; font-weight: 600; border: 1px solid var(--blue-2); }
        .month-summary-table td { padding: 15px; text-align: center; border: 1px solid var(--border); font-weight: 500; font-size: 18px; }
        .month-summary-table .green { color: #059669; font-weight: 700; }
        .month-summary-table .red { color: #dc2626; font-weight: 700; }
        .month-summary-container { display: grid; grid-template-columns: repeat(auto-fit, minmax(300px, 1fr)); gap: 20px; margin: 20px; }
        .summary-section { background: var(--surface); border-radius: 10px; padding: 20px; border: 2px solid var(--border); }
        .summary-section h4 { color: var(--blue-1); margin-bottom: 15px; font-size: 16px; display: flex; align-items: center; gap: 8px; padding-bottom: 10px; border-bottom: 2px solid var(--border); }
        .summary-list { max-height: 200px; overflow-y: auto; }
        .summary-item { display: flex; justify-content: space-between; padding: 10px 0; border-bottom: 1px solid var(--border); }
        .summary-item:last-child { border-bottom: none; }
        .summary-item span:first-child { color: var(--text-sub); }
        .summary-item .amount { font-weight: 600; }
        .chart-section { background: var(--surface); border-radius: 20px; padding: 30px; margin-bottom: 30px; border: 2px solid var(--border); }
        .chart-header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px; flex-wrap: wrap; gap: 15px; }
        .chart-header h2 { color: var(--blue-1); font-size: 1.8rem; }
        .category-checkboxes { display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 15px; margin-bottom: 25px; padding: 20px; background: var(--bg); border-radius: 10px; border: 2px solid var(--border); }
        .checkbox-item { display: flex; align-items: center; gap: 10px; cursor: pointer; padding: 10px; border-radius: 8px; transition: background 0.3s ease; }
        .checkbox-item:hover { background: var(--blue-light); }
        .checkbox-item input[type="checkbox"] { width: 20px; height: 20px; cursor: pointer; accent-color: var(--blue-2); }
        .checkbox-item label { cursor: pointer; font-weight: 500; color: var(--text-sub); display: flex; align-items: center; gap: 8px; }
        .color-indicator { width: 15px; height: 15px; border-radius: 3px; display: inline-block; }
        .chart-container { position: relative; height: 400px; margin-top: 20px; }
        .year-selector { display: flex; align-items: center; gap: 10px; }
        .year-selector label { font-weight: 500; color: var(--text-sub); }
        .year-selector select { padding: 8px 15px; background: var(--surface); border: 2px solid var(--border); border-radius: 8px; font-size: 16px; cursor: pointer; color: var(--text); font-family: 'DM Sans', sans-serif; }
        .month-selector { display: flex; gap: 10px; align-items: center; flex-wrap: wrap; }
        .month-selector select, .month-selector input { padding: 8px 12px; background: var(--surface); border: 2px solid var(--border); border-radius: 8px; font-size: 14px; color: var(--text); font-family: 'DM Sans', sans-serif; }
        #chatPage { display: none; flex-direction: column; height: calc(100vh - 160px); min-height: 400px; margin-top: 20px; }
        #chatPage.active { display: flex; }
        .chat-body-wrap { background: var(--surface); border-radius: 20px; border: 2px solid var(--border); box-shadow: 0 10px 40px rgba(26,58,124,0.08); display: flex; flex-direction: column; flex: 1; overflow: hidden; }
        .chat-header-bar { display: flex; align-items: center; gap: 12px; padding: 14px 20px; background: var(--surface); border-bottom: 1px solid var(--border); flex-shrink: 0; }
        .chat-logo { width: 38px; height: 38px; border-radius: 10px; background: var(--gradient); display: grid; place-items: center; color: #fff; flex-shrink: 0; }
        .chat-logo .material-symbols-outlined { font-size: 20px; }
        .chat-header-info h2 { font-size: 0.95rem; font-weight: 600; color: var(--text); }
        .chat-header-status { display: flex; align-items: center; gap: 5px; font-size: 0.72rem; color: #22c55e; margin-top: 1px; }
        .dot { width: 6px; height: 6px; border-radius: 50%; background: #22c55e; }
        .chat-header-pill { margin-left: auto; font-size: 0.7rem; font-weight: 500; color: var(--blue-2); background: var(--blue-mid); border-radius: 20px; padding: 4px 11px; }
        .chat-messages { flex: 1; overflow-y: auto; padding: 20px 16px 12px; display: flex; flex-direction: column; gap: 14px; }
        .chat-messages::-webkit-scrollbar { width: 3px; }
        .chat-messages::-webkit-scrollbar-thumb { background: var(--border); border-radius: 10px; }
        .welcome { align-self: center; max-width: 460px; width: 100%; text-align: center; padding: 32px 24px; background: var(--surface); border: 1px solid var(--border); border-radius: 20px; box-shadow: var(--shadow-md); }
        .welcome-icon { width: 52px; height: 52px; border-radius: 14px; background: var(--gradient); display: grid; place-items: center; margin: 0 auto 16px; color: #fff; }
        .welcome-icon .material-symbols-outlined { font-size: 26px; }
        .welcome h3 { font-size: 1.1rem; font-weight: 600; color: var(--text); margin-bottom: 8px; }
        .welcome p { font-size: 0.83rem; color: var(--text-sub); line-height: 1.65; margin-bottom: 20px; }
        .chips { display: flex; flex-wrap: wrap; gap: 7px; justify-content: center; }
        .chip { background: var(--blue-light); border: 1px solid var(--blue-mid); color: var(--blue-1); border-radius: 20px; padding: 7px 13px; font-size: 0.76rem; font-family: 'DM Sans', sans-serif; font-weight: 500; cursor: pointer; transition: all 0.18s; }
        .chip:hover { background: var(--blue-mid); border-color: var(--blue-3); color: var(--blue-2); transform: translateY(-1px); box-shadow: 0 2px 8px rgba(37,99,235,0.14); }
        .msg-row { display: flex; gap: 9px; max-width: 680px; width: 100%; animation: fadeIn 0.28s ease both; }
        .msg-row.user { align-self: flex-end; flex-direction: row-reverse; }
        .msg-row.bot { align-self: flex-start; }
        .av { width: 30px; height: 30px; border-radius: 8px; display: grid; place-items: center; flex-shrink: 0; margin-top: 4px; }
        .av .material-symbols-outlined { font-size: 16px; }
        .msg-row.user .av { background: var(--gradient); color: #fff; }
        .msg-row.bot .av { background: var(--blue-light); border: 1px solid var(--blue-mid); color: var(--blue-2); }
        .bwrap { display: flex; flex-direction: column; }
        .msg-row.user .bwrap { align-items: flex-end; }
        .bubble { padding: 11px 15px; border-radius: 16px; font-size: 0.875rem; line-height: 1.65; max-width: min(72vw, 500px); word-break: break-word; }
        .msg-row.user .bubble { background: var(--gradient); color: #fff; border-bottom-right-radius: 4px; box-shadow: 0 3px 12px rgba(37,99,235,0.28); }
        .msg-row.bot .bubble { background: var(--surface); border: 1px solid var(--border); color: var(--text); border-bottom-left-radius: 4px; box-shadow: var(--shadow-sm); }
        .btime { font-size: 0.67rem; color: var(--text-muted); margin-top: 3px; padding: 0 2px; }
        .bubble strong { color: var(--blue-1); font-weight: 600; }
        .msg-row.user .bubble strong { color: #bfdbfe; }
        .bubble code { background: var(--blue-light); color: var(--blue-2); padding: 1px 5px; border-radius: 4px; font-family: 'DM Mono', monospace; font-size: 0.81em; }
        .bubble ul, .bubble ol { padding-left: 16px; margin-top: 5px; }
        .bubble li { margin-bottom: 2px; }
        .typing { display: flex; align-items: center; gap: 4px; padding: 13px 16px; }
        .typing span { width: 7px; height: 7px; border-radius: 50%; background: var(--blue-3); animation: blink 1.2s infinite ease-in-out; }
        .typing span:nth-child(2) { animation-delay: .18s; }
        .typing span:nth-child(3) { animation-delay: .36s; }
        @keyframes blink { 0%,80%,100% { transform: scale(0.7); opacity: 0.3; } 40% { transform: scale(1); opacity: 1; } }
        .chat-input-area { flex-shrink: 0; padding: 10px 16px 16px; background: var(--surface); border-top: 1px solid var(--border); }
        .input-wrap { display: flex; align-items: flex-end; gap: 8px; background: var(--bg); border: 1.5px solid var(--border); border-radius: 14px; padding: 9px 10px 9px 14px; transition: border-color 0.18s, box-shadow 0.18s; }
        .input-wrap:focus-within { border-color: var(--blue-3); box-shadow: 0 0 0 3px rgba(59,130,246,0.10); }
        textarea { flex: 1; background: transparent; border: none; outline: none; color: var(--text); font-family: 'DM Sans', sans-serif; font-size: 0.875rem; line-height: 1.5; resize: none; max-height: 120px; min-height: 22px; }
        textarea::placeholder { color: var(--text-muted); }
        .send-btn { width: 36px; height: 36px; border-radius: 10px; border: none; background: var(--gradient); color: #fff; cursor: pointer; display: grid; place-items: center; flex-shrink: 0; transition: all 0.18s; box-shadow: 0 2px 8px rgba(37,99,235,0.3); }
        .send-btn .material-symbols-outlined { font-size: 18px; }
        .send-btn:hover { transform: scale(1.06); box-shadow: 0 4px 14px rgba(37,99,235,0.4); }
        .send-btn:active { transform: scale(0.95); }
        .send-btn:disabled { opacity: 0.4; cursor: not-allowed; transform: none; box-shadow: none; }
        .hint { text-align: center; font-size: 0.66rem; color: var(--text-muted); margin-top: 6px; font-family: 'DM Mono', monospace; }
        .modal { display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(15,23,42,0.5); justify-content: center; align-items: center; z-index: 9999; }
        .modal.active { display: flex; }
        .modal-content { background: var(--surface); padding: 30px; border-radius: 15px; max-width: 400px; width: 90%; border: 2px solid var(--border); box-shadow: 0 20px 60px rgba(0,0,0,0.1); }
        .modal-content h3 { margin-bottom: 20px; color: var(--blue-1); }
        .modal-content p { color: var(--text-sub); margin-bottom: 15px; }
        .modal-buttons { display: flex; gap: 10px; margin-top: 20px; }
        .btn-primary, .btn-secondary, .btn-danger { flex: 1; padding: 12px; border: 2px solid; border-radius: 8px; font-size: 16px; font-weight: 600; cursor: pointer; transition: all 0.3s ease; font-family: 'DM Sans', sans-serif; }
        .btn-primary { background: var(--gradient); color: white; border-color: var(--blue-2); }
        .btn-secondary { background: var(--surface); color: var(--text-sub); border-color: var(--border); }
        .btn-danger { background: #dc2626; color: white; border-color: #dc2626; }
        .btn-primary:hover { transform: translateY(-2px); box-shadow: 0 4px 15px rgba(37,99,235,0.3); }
        .btn-secondary:hover { background: var(--blue-light); color: var(--text); }
        .btn-danger:hover { background: #b91c1c; border-color: #b91c1c; transform: translateY(-2px); }
        #loading { display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(15,23,42,0.65); justify-content: center; align-items: center; flex-direction: column; z-index: 9999; }
        #loading.active { display: flex; }
        .spinner { border: 4px solid rgba(255,255,255,0.2); border-top: 4px solid white; border-radius: 50%; width: 50px; height: 50px; animation: spin 1s linear infinite; }
        @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }
        #loading-text { color: white; margin-top: 20px; font-size: 18px; }
        .logout-btn { position: fixed; top: 20px; right: 20px; background: var(--surface); border: 2px solid var(--border); padding: 10px 20px; border-radius: 25px; cursor: pointer; font-size: 14px; display: flex; align-items: center; gap: 5px; box-shadow: var(--shadow-sm); transition: all 0.3s ease; z-index: 999; color: var(--blue-1); font-family: 'DM Sans', sans-serif; font-weight: 500; }
        .logout-btn:hover { transform: translateY(-2px); box-shadow: var(--shadow-md); background: var(--blue-1); color: white; border-color: var(--blue-1); }

        /* ── PDF MODAL REDESIGN ───────────────────────────────────────── */
        #pdfModal .modal-content { max-width: 480px; padding: 0; border-radius: 20px; overflow: hidden; border: none; box-shadow: 0 30px 80px rgba(15,23,42,0.25), 0 0 0 1px rgba(255,255,255,0.05); }
        .pdf-modal-header { background: var(--gradient); padding: 28px 30px 24px; position: relative; overflow: hidden; }
        .pdf-modal-icon { width: 52px; height: 52px; border-radius: 14px; background: rgba(255,255,255,0.18); backdrop-filter: blur(8px); display: flex; align-items: center; justify-content: center; margin-bottom: 14px; border: 1.5px solid rgba(255,255,255,0.25); position: relative; z-index: 1; }
        .pdf-modal-icon .material-symbols-outlined { font-size: 26px; color: white; }
        .pdf-modal-header h3 { color: white; font-size: 1.3rem; font-weight: 700; margin-bottom: 4px; position: relative; z-index: 1; }
        .pdf-modal-header p { color: rgba(255,255,255,0.72); font-size: 0.82rem; position: relative; z-index: 1; margin: 0; }
        .pdf-modal-body { padding: 28px 30px 24px; background: var(--surface); }
        .pdf-select-row { display: grid; grid-template-columns: 1fr 1fr; gap: 14px; margin-bottom: 24px; }
        .pdf-field label { display: block; font-size: 0.75rem; font-weight: 600; color: var(--text-muted); text-transform: uppercase; letter-spacing: 0.08em; margin-bottom: 8px; }
        .pdf-field select { width: 100%; padding: 11px 14px; background: var(--bg); border: 1.5px solid var(--border); border-radius: 10px; font-size: 0.9rem; color: var(--text); font-family: 'DM Sans', sans-serif; font-weight: 500; cursor: pointer; transition: all 0.2s ease; appearance: none; background-image: url("data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' width='16' height='16' viewBox='0 0 24 24' fill='none' stroke='%2364748b' stroke-width='2'%3E%3Cpath d='M6 9l6 6 6-6'/%3E%3C/svg%3E"); background-repeat: no-repeat; background-position: right 12px center; padding-right: 36px; }
        .pdf-field select:focus { outline: none; border-color: var(--blue-3); box-shadow: 0 0 0 3px rgba(59,130,246,0.12); background-color: var(--surface); }
        .pdf-preview-strip { background: var(--blue-light); border: 1.5px solid var(--blue-mid); border-radius: 12px; padding: 14px 16px; display: flex; align-items: center; gap: 12px; margin-bottom: 22px; }
        .pdf-preview-strip .material-symbols-outlined { font-size: 20px; color: var(--blue-2); flex-shrink: 0; }
        .pdf-preview-strip span { font-size: 0.82rem; color: var(--blue-1); font-weight: 500; }
        .pdf-preview-strip strong { color: var(--blue-2); }
        .pdf-modal-actions { display: flex; gap: 10px; }
        .btn-pdf-cancel { flex: 0 0 auto; padding: 12px 20px; background: transparent; border: 1.5px solid var(--border); border-radius: 10px; font-size: 0.9rem; font-weight: 600; color: var(--text-sub); cursor: pointer; transition: all 0.2s ease; font-family: 'DM Sans', sans-serif; }
        .btn-pdf-cancel:hover { background: var(--bg); border-color: var(--text-muted); color: var(--text); }
        .btn-pdf-download { flex: 1; padding: 12px 20px; background: var(--gradient); border: none; border-radius: 10px; font-size: 0.9rem; font-weight: 600; color: white; cursor: pointer; transition: all 0.2s ease; font-family: 'DM Sans', sans-serif; display: flex; align-items: center; justify-content: center; gap: 8px; box-shadow: 0 4px 14px rgba(37,99,235,0.3); }
        .btn-pdf-download:hover { transform: translateY(-1px); box-shadow: 0 6px 20px rgba(37,99,235,0.4); }
        .btn-pdf-download .material-symbols-outlined { font-size: 18px; }

        @media (max-width: 768px) {
            body { padding-bottom: 120px; }
            .container { padding: 20px; }
            .unlock-input-group input { max-width: 200px; }
            .main-balance-val { font-size: 36px; }
            .filter-controls { flex-direction: column; }
            .filter-select-group { min-width: 100%; }
            .month-summary-container { grid-template-columns: 1fr; }
            .nav-item { padding: 10px 10px; min-width: 60px; }
            .nav-item .material-symbols-outlined { font-size: 20px; }
            .nav-item span:not(.material-symbols-outlined) { font-size: 10px; }
            .bottom-nav { bottom: 10px; padding: 6px; min-width: 300px; }
            .chart-container { height: 300px; }
            .category-checkboxes { grid-template-columns: 1fr; }
            .logout-btn { padding: 8px 15px; font-size: 12px; }
            .recent-table { font-size: 14px; }
            .recent-table th, .recent-table td { padding: 10px 5px; }
            .month-summary-table { margin: 10px; }
            .month-summary-table td { padding: 10px; font-size: 16px; }
            #chatPage { height: calc(100vh - 200px); }
            .pdf-select-row { grid-template-columns: 1fr; }
            #pdfModal .modal-content { max-width: 95vw; margin: 0 10px; }
        }
        @media (max-width: 480px) {
            .page-title { font-size: 1.5rem; }
            .unlock-input-group input { max-width: 130px; }
            .main-balance-val { font-size: 28px; }
            .chart-container { height: 250px; }
            .bottom-nav { min-width: 270px; }
            .month-summary-table td { font-size: 14px; padding: 8px; }
        }
    </style>
</head>
<body>

    <div id="loginPage">
        <div class="login-container">
            <h1>
                <span class="material-symbols-outlined" style="color:var(--blue-2);">account_balance_wallet</span>
                Expense Tracker
            </h1>
            <form id="loginForm">
                <div class="login-form-group">
                    <label>Username</label>
                    <input type="text" id="loginUsername" required autocomplete="username" placeholder="Enter username">
                </div>
                <div class="login-form-group">
                    <label>Password</label>
                    <input type="password" id="loginPassword" required autocomplete="current-password" placeholder="Enter password">
                </div>
                <button type="submit" class="btn-login" id="loginBtn">
                    <span id="loginBtnText">Login</span>
                    <div class="spinner-sm" id="loginSpinner"></div>
                </button>
                <div class="login-links">
                    <a href="https://mantixlk.com/set-id">Change password</a>
                    <a href="https://mantixlk.com/forgot-id">Forgot password</a>
                </div>
                <div class="error-message" id="loginError">Invalid username or password.</div>
            </form>
            <h1 style="margin-top:40px; margin-bottom:5px; font-size:1.3rem;">Mantix_Lk</h1>
            <p style="text-align:center; color:var(--text-sub);">CONTACT: <a href="/cdn-cgi/l/email-protection#31525e5f45505245715c505f4558495d5a1f525e5c" style="color:var(--blue-2);"><span class="__cf_email__" data-cfemail="60030f0e14010314200d010e1409180c0b4e030f0d">[email&#160;protected]</span></a></p>
        </div>
    </div>

    <div id="appContainer">
        <button class="logout-btn" onclick="logout()">
            <span class="material-symbols-outlined">logout</span>
            Logout
        </button>

        <!-- Entry Form Page -->
        <div id="entryPage" class="page">
            <div class="container">
                <h1 class="page-title">
                    <span class="material-symbols-outlined">forms_add_on</span>
                    Entry Form
                </h1>

                <div class="admin-unlock" id="formLock">
                    <h3><span class="material-symbols-outlined">lock</span> Form Locked</h3>
                    <p>Enter admin password to unlock the entry form</p>
                    <div class="unlock-input-group">
                        <input type="password" id="formUnlockPassword" placeholder="Admin Password">
                        <button class="btn-unlock" onclick="unlockForm()">Unlock</button>
                    </div>
                </div>

                <form id="expenseForm" style="display:none;">
                    <div class="form-group">
                        <label>Select Date</label>
                        <input type="date" id="date" required onchange="autoSetDay()">
                    </div>
                    <div class="form-group">
                        <label>Day</label>
                        <select id="day" required>
                            <option value="MON">MON</option><option value="TUE">TUE</option>
                            <option value="WED">WED</option><option value="THU">THU</option>
                            <option value="FRI">FRI</option><option value="SAT">SAT</option>
                            <option value="SUN">SUN</option>
                        </select>
                    </div>
                    <div class="form-group">
                        <label>Type</label>
                        <select id="transType" required onchange="toggleCategoryField()">
                            <option value="Debit">Debit (Expense)</option>
                            <option value="Credit">Credit (Income)</option>
                        </select>
                    </div>
                    <div class="form-group" id="categoryGroup">
                        <label>Category</label>
                        <select id="categorySelect" required>
                            <option value="" disabled selected>Select a category</option>
                            <option value="Rent">Rent</option>
                            <option value="Current Usage">Current Usage</option>
                            <option value="Water Usage">Water Usage</option>
                            <option value="Grocery">Grocery</option>
                            <option value="Reload">Reload</option>
                            <option value="Household essentials">Household essentials</option>
                            <option value="Other">Other</option>
                        </select>
                        <input type="text" id="categoryText" placeholder="e.g. Salary, Freelance, Gift..." style="display:none;" required>
                    </div>
                    <div class="form-group">
                        <label>Details</label>
                        <input type="text" id="details" placeholder="Type Here" required>
                    </div>
                    <div class="form-group">
                        <label>Amount</label>
                        <input type="number" id="amount" step="0.01" placeholder="0.00" required>
                    </div>
                    <button type="submit" class="btn-submit">Submit Entry</button>
                </form>
            </div>
        </div>

        <!-- Dashboard Page -->
        <div id="dashboardPage" class="page active">
            <div class="container">
                <h1 class="page-title">
                    <span class="material-symbols-outlined">dashboard</span>
                    Dashboard
                </h1>
                <div class="main-balance-card">
                    <div class="main-balance-lbl">Current Balance</div>
                    <div class="main-balance-val" id="d-bal">0.00</div>
                </div>
                <h3 style="margin-top:0; display:flex; justify-content:space-between; align-items:center;">
                    <span>Monthly Breakdown</span>
                    <span class="action-icons">
                        <button class="icon-btn" onclick="jumpToRecentTransactions()" title="Jump to History">
                            <span class="material-symbols-outlined">history</span>
                        </button>
                        <button class="icon-btn" onclick="showPdfModal()" title="Download PDF Report">
                            <span class="material-symbols-outlined">download</span>
                        </button>
                    </span>
                </h3>
                <div class="filter-container">
                    <div class="filter-controls">
                        <div class="filter-select-group">
                            <label for="yearFilter">Year:</label>
                            <select id="yearFilter" onchange="filterMonthlyView()"></select>
                        </div>
                        <div class="filter-select-group">
                            <label for="monthSelect">Month:</label>
                            <select id="monthSelect" onchange="filterMonthlyView()">
                                <option value="all">All</option>
                            </select>
                        </div>
                    </div>
                </div>
                <div id="monthly-container">
                    <div style="text-align:center; color:var(--text-sub); padding:20px;">Loading data...</div>
                </div>
                <h3 id="recent-transactions-header">Recent Transactions</h3>
                <div class="table-wrapper">
                    <table class="recent-table">
                        <thead>
                            <tr>
                                <th class="date-col">Date</th>
                                <th>Category / Details</th>
                                <th class="amount-col">Amount</th>
                                <th class="amount-col">Balance</th>
                                <th class="action-col">Action</th>
                            </tr>
                        </thead>
                        <tbody id="tableBody">
                            <tr><td colspan="5" style="text-align:center; color:var(--text-sub);">Loading...</td></tr>
                        </tbody>
                    </table>
                </div>
            </div>
        </div>

        <!-- Analytics Page -->
        <div id="analyticsPage" class="page">
            <div class="container">
                <h1 class="page-title">
                    <span class="material-symbols-outlined">monitoring</span>
                    Analytics
                </h1>
                <div class="chart-section">
                    <div class="chart-header">
                        <h2>Monthly Comparison</h2>
                        <div class="month-selector">
                            <label>Compare with:</label>
                            <select id="compareMonthSelect" onchange="updateMonthlyChart()">
                                <option value="1">January</option><option value="2">February</option>
                                <option value="3">March</option><option value="4">April</option>
                                <option value="5">May</option><option value="6">June</option>
                                <option value="7">July</option><option value="8">August</option>
                                <option value="9">September</option><option value="10">October</option>
                                <option value="11">November</option><option value="12">December</option>
                            </select>
                            <select id="compareYearSelect" onchange="updateMonthlyChart()"></select>
                        </div>
                    </div>
                    <div class="category-checkboxes" id="monthlyCheckboxes"></div>
                    <div class="chart-container"><canvas id="monthlyChart"></canvas></div>
                </div>
                <div class="chart-section">
                    <div class="chart-header">
                        <h2>Yearly Trends</h2>
                        <div class="year-selector">
                            <label for="yearSelect">Year:</label>
                            <select id="yearSelect" onchange="updateYearlyChart()"></select>
                        </div>
                    </div>
                    <div class="category-checkboxes" id="categoryCheckboxes"></div>
                    <div class="chart-container"><canvas id="yearlyChart"></canvas></div>
                </div>
            </div>
        </div>

        <!-- Chat Page -->
        <div id="chatPage" class="page">
            <div class="chat-body-wrap">
                <div class="chat-header-bar">
                    <div class="chat-logo"><span class="material-symbols-outlined">smart_toy</span></div>
                    <div class="chat-header-info">
                        <h2>Finance Assistant</h2>
                        <div class="chat-header-status"><span class="dot"></span> Online &middot; Ready</div>
                    </div>
                    <div class="chat-header-pill">Mantix_LK</div>
                </div>
                <div class="chat-messages" id="chatBody">
                    <div class="welcome" id="welcomeCard">
                        <div class="welcome-icon"><span class="material-symbols-outlined">auto_awesome</span></div>
                        <h3>Hi, I'm your Finance Assistant</h3>
                        <p>Ask me anything about your transactions — monthly summaries, spending by category, balances, or money-saving tips.</p>
                        <div class="chips">
                            <button class="chip" onclick="sendChip(this)">What's my balance?</button>
                            <button class="chip" onclick="sendChip(this)">January spending</button>
                            <button class="chip" onclick="sendChip(this)">Total rent paid</button>
                            <button class="chip" onclick="sendChip(this)">Biggest expenses</button>
                            <button class="chip" onclick="sendChip(this)">Credits this month</button>
                            <button class="chip" onclick="sendChip(this)">Tips to save money</button>
                        </div>
                    </div>
                </div>
                <div class="chat-input-area">
                    <div class="input-wrap">
                        <textarea id="userInput" placeholder="Ask about your finances…" rows="1" onkeydown="handleKey(event)" oninput="autoGrow(this)"></textarea>
                        <button class="send-btn" id="sendBtn" onclick="sendMessage()" title="Send">
                            <span class="material-symbols-outlined">send</span>
                        </button>
                    </div>
                    <p class="hint">Enter &middot; send &nbsp;|&nbsp; Shift+Enter &middot; new line</p>
                </div>
            </div>
        </div>

        <!-- Bottom Navigation -->
        <div class="bottom-nav">
            <div class="nav-item" onclick="switchPage('entry')">
                <span class="material-symbols-outlined">forms_add_on</span>
                <span>Form</span>
            </div>
            <div class="nav-item active" onclick="switchPage('dashboard')">
                <span class="material-symbols-outlined">tile_medium</span>
                <span>Dashboard</span>
            </div>
            <div class="nav-item" onclick="switchPage('analytics')">
                <span class="material-symbols-outlined">monitoring</span>
                <span>Analytics</span>
            </div>
            <div class="nav-item" onclick="switchPage('chat')">
                <span class="material-symbols-outlined">smart_toy</span>
                <span>Chat</span>
            </div>
        </div>
    </div>

    <!-- Delete Modal -->
    <div id="deleteModal" class="modal">
        <div class="modal-content">
            <h3>Delete Transaction</h3>
            <p>Enter admin password to confirm deletion:</p>
            <div class="form-group">
                <input type="password" id="deletePassword" placeholder="Admin Password">
            </div>
            <div class="modal-buttons">
                <button class="btn-danger" onclick="confirmDelete()">Delete</button>
                <button class="btn-secondary" onclick="closeDeleteModal()">Cancel</button>
            </div>
        </div>
    </div>

    <!-- PDF Modal -->
    <div id="pdfModal" class="modal">
        <div class="modal-content">
            <div class="pdf-modal-header">
                <div class="pdf-modal-icon">
                    <span class="material-symbols-outlined">picture_as_pdf</span>
                </div>
                <h3>Export Report</h3>
                <p>Select a period to generate your statement</p>
            </div>
            <div class="pdf-modal-body">
                <div class="pdf-select-row">
                    <div class="pdf-field">
                        <label>Year</label>
                        <select id="pdfYear" onchange="updatePdfPreview()"></select>
                    </div>
                    <div class="pdf-field">
                        <label>Month</label>
                        <select id="pdfMonth" onchange="updatePdfPreview()">
                            <option value="1">January</option><option value="2">February</option>
                            <option value="3">March</option><option value="4">April</option>
                            <option value="5">May</option><option value="6">June</option>
                            <option value="7">July</option><option value="8">August</option>
                            <option value="9">September</option><option value="10">October</option>
                            <option value="11">November</option><option value="12">December</option>
                        </select>
                    </div>
                </div>
                <div class="pdf-preview-strip">
                    <span class="material-symbols-outlined">description</span>
                    <span>Exporting: <strong id="pdfPreviewLabel">—</strong></span>
                </div>
                <div class="pdf-modal-actions">
                    <button class="btn-pdf-cancel" onclick="closePdfModal()">Cancel</button>
                    <button class="btn-pdf-download" onclick="generatePDF()">
                        <span class="material-symbols-outlined">download</span>
                        Download PDF
                    </button>
                </div>
            </div>
        </div>
    </div>

    <!-- Loading Spinner -->
    <div id="loading">
        <div class="spinner"></div>
        <div id="loading-text">Processing...</div>
    </div>

    <div id="pdfContent" style="position:absolute;left:-9999px;"></div>

    <script data-cfasync="false" src="/cdn-cgi/scripts/5c5dd728/cloudflare-static/email-decode.min.js"></script><script>
        // ── Constants ──────────────────────────────────────────────────────
        const GS_LOGIN_URL    = "https://script.google.com/macros/s/AKfycbzYpC4HDaDxIW8nj0A4epKr6CRkeskWnXsnZXDbsHQs0CrIWzx5AXkgQdFAK28cvX1n/exec";
        const SCRIPT_URL      = "https://script.google.com/macros/s/AKfycbxFsXJKc4O6bSpoXKOSxVHc-OxUmBmLkU6ho6-fx9z3nXa4fY6PdMG6cL0bmwI-WmL3/exec";
        const CHAT_SCRIPT_URL = "https://script.google.com/macros/s/AKfycbxFsXJKc4O6bSpoXKOSxVHc-OxUmBmLkU6ho6-fx9z3nXa4fY6PdMG6cL0bmwI-WmL3/exec";
        // ADMIN_PASSWORD is stored per-user in the Google Sheet (aid column).
        // For form unlock & delete we still need a local admin password.
        // It will be set after login from the sheet data.
        let ADMIN_PASSWORD = '';

        const MONTH_NAMES       = ['January','February','March','April','May','June','July','August','September','October','November','December'];
        const MONTH_NAMES_SHORT = ['Jan','Feb','Mar','Apr','May','Jun','Jul','Aug','Sep','Oct','Nov','Dec'];

        const CATEGORIES = [
            { name: 'Rent',                 color: '#9F7AEA', keywords: ['hostel','rent','reservation','accommodation'] },
            { name: 'Current Usage',        color: '#FFD700', keywords: ['current','electricity','power','electric bill','eb'] },
            { name: 'Water Usage',          color: '#00B5D8', keywords: ['water','water bill','aqua'] },
            { name: 'Grocery',              color: '#48BB78', keywords: ['grocery','supermarket','market','vegetables','fruits','food items'] },
            { name: 'Reload',               color: '#E53E3E', keywords: ['reload','topup','recharge','mobile','data'] },
            { name: 'Household essentials', color: '#00989f', keywords: ['household','shampoo','conditioner','soap','deodorant','towel','essentials','cleaning supplies','domestic'] },
            { name: 'Other',                color: '#FF46D2', keywords: [] }
        ];

        let allRecords   = [];
        let monthlyChart = null;
        let yearlyChart  = null;
        let formUnlocked = false;
        let deleteRowData = null;

        // ── Login (Google Sheets) ──────────────────────────────────────────
        document.getElementById('loginForm').addEventListener('submit', async function(e) {
            e.preventDefault();
            const username    = document.getElementById('loginUsername').value.trim();
            const password    = document.getElementById('loginPassword').value;
            const errorEl     = document.getElementById('loginError');
            const loginBtn    = document.getElementById('loginBtn');
            const loginSpinner = document.getElementById('loginSpinner');
            const btnText     = document.getElementById('loginBtnText');

            errorEl.style.display = 'none';
            loginBtn.disabled = true;
            loginSpinner.style.display = 'block';
            btnText.textContent = 'Signing in…';

            try {
                const params = new URLSearchParams({ op: 'login', username, password });
                const res  = await fetch(GS_LOGIN_URL + '?' + params.toString());
                const data = await res.json();

                if (data.result === 'success') {
                    // Store admin password returned from sheet so form lock & delete work
                    ADMIN_PASSWORD = data.adminPassword || '';
                    if (!ADMIN_PASSWORD) {
                        console.warn('Admin password not returned from server. Form unlock and delete will not work.');
                    }
                    document.getElementById('loginPage').style.display = 'none';
                    document.getElementById('appContainer').style.display = 'block';
                    loadDashboardData();
                } else {
                    errorEl.textContent = data.error || 'Invalid username or password.';
                    errorEl.style.display = 'block';
                }
            } catch (err) {
                errorEl.textContent = 'Connection error. Please try again.';
                errorEl.style.display = 'block';
            } finally {
                loginBtn.disabled = false;
                loginSpinner.style.display = 'none';
                btnText.textContent = 'Login';
            }
        });

        function logout() {
            if (confirm('Are you sure you want to logout?')) {
                window.location.href = 'https://mantixlk.com';
            }
        }

        // ── Page Navigation ────────────────────────────────────────────────
        function switchPage(page) {
            document.querySelectorAll('.page').forEach(p => p.classList.remove('active'));
            document.querySelectorAll('.nav-item').forEach(n => n.classList.remove('active'));
            if (page === 'entry') {
                document.getElementById('entryPage').classList.add('active');
                document.querySelectorAll('.nav-item')[0].classList.add('active');
                checkFormLock();
            } else if (page === 'dashboard') {
                document.getElementById('dashboardPage').classList.add('active');
                document.querySelectorAll('.nav-item')[1].classList.add('active');
                loadDashboardData();
            } else if (page === 'analytics') {
                document.getElementById('analyticsPage').classList.add('active');
                document.querySelectorAll('.nav-item')[2].classList.add('active');
                loadAnalyticsData();
            } else if (page === 'chat') {
                document.getElementById('chatPage').classList.add('active');
                document.querySelectorAll('.nav-item')[3].classList.add('active');
            }
        }

        // ── Form Lock ──────────────────────────────────────────────────────
        function checkFormLock() {
            if (formUnlocked) {
                document.getElementById('formLock').style.display    = 'none';
                document.getElementById('expenseForm').style.display = 'block';
            } else {
                document.getElementById('formLock').style.display    = 'block';
                document.getElementById('expenseForm').style.display = 'none';
            }
        }

        function unlockForm() {
            const password = document.getElementById('formUnlockPassword').value;
            if (password === ADMIN_PASSWORD) {
                formUnlocked = true;
                checkFormLock();
                document.getElementById('date').valueAsDate = new Date();
                autoSetDay();
                toggleCategoryField();
            } else {
                alert('Incorrect admin password!');
            }
        }

        function autoSetDay() {
            const d = document.getElementById('date').value;
            if (!d) return;
            const days = ['SUN','MON','TUE','WED','THU','FRI','SAT'];
            document.getElementById('day').value = days[new Date(d).getDay()];
        }

        // ── Category Toggle ────────────────────────────────────────────────
        function toggleCategoryField() {
            const type = document.getElementById('transType').value;
            const sel  = document.getElementById('categorySelect');
            const txt  = document.getElementById('categoryText');
            if (type === 'Credit') {
                sel.style.display = 'none';
                sel.required      = false;
                txt.style.display = 'block';
                txt.required      = true;
            } else {
                txt.style.display = 'none';
                txt.required      = false;
                sel.style.display = 'block';
                sel.required      = true;
            }
        }

        // ── Form Submit ────────────────────────────────────────────────────
        document.getElementById('expenseForm').addEventListener('submit', function(e) {
            e.preventDefault();
            showLoading(true, "Saving...");
            const type     = document.getElementById('transType').value;
            const category = type === 'Credit'
                ? document.getElementById('categoryText').value
                : document.getElementById('categorySelect').value;
            const params = new URLSearchParams({
                op:       'submit',
                date:     document.getElementById('date').value,
                day:      document.getElementById('day').value,
                category: category,
                details:  document.getElementById('details').value,
                type:     type,
                amount:   document.getElementById('amount').value
            });
            fetch(SCRIPT_URL + "?" + params.toString())
            .then(res => res.json())
            .then(data => {
                showLoading(false);
                if (data.result === 'success') {
                    alert("Submitted Successfully!");
                    document.getElementById('expenseForm').reset();
                    document.getElementById('date').valueAsDate = new Date();
                    autoSetDay();
                    toggleCategoryField();
                } else {
                    alert("Error: " + (data.error || 'Unknown error'));
                }
            })
            .catch(err => { showLoading(false); alert("Error: " + err); });
        });

        // ── Dashboard ──────────────────────────────────────────────────────
        function loadDashboardData() {
            showLoading(true, "Loading Dashboard...");
            fetch(SCRIPT_URL + "?op=read")
            .then(res => res.json())
            .then(data => {
                showLoading(false);
                allRecords = data.records;
                displayDashboard(data);
            })
            .catch(err => { showLoading(false); alert("Failed to load data: " + err); });
        }

        function displayDashboard(data) {
            const balance = data.summary.bal || 0;
            document.getElementById('d-bal').innerText = balance.toLocaleString('en-US', {minimumFractionDigits:2, maximumFractionDigits:2});
            populateYearFilter();
            renderMonthly(data.records);
            renderRecentTable(data.records);
        }

        function populateYearFilter() {
            const yearFilter = document.getElementById('yearFilter');
            const pdfYear    = document.getElementById('pdfYear');
            const years      = new Set();
            allRecords.forEach(row => { years.add(parseInt(String(row[0]).substring(0,4))); });
            const sortedYears = Array.from(years).sort((a,b) => b-a);
            yearFilter.innerHTML = '';
            pdfYear.innerHTML    = '';
            sortedYears.forEach(year => {
                const o1 = document.createElement('option'); o1.value = o1.innerText = year; yearFilter.appendChild(o1);
                const o2 = document.createElement('option'); o2.value = o2.innerText = year; pdfYear.appendChild(o2);
            });
            if (sortedYears.length > 0) {
                yearFilter.value = sortedYears[0];
                document.getElementById('monthSelect').innerHTML = '<option value="all">All</option>' +
                    Array.from({length:12}, (_,i) => `<option value="${i+1}">${MONTH_NAMES_SHORT[i]}</option>`).join('');
            }
            updatePdfPreview();
        }

        function filterMonthlyView() { renderMonthly(allRecords); }

        function renderMonthly(records) {
            const selectedYear  = document.getElementById('yearFilter').value;
            const selectedMonth = document.getElementById('monthSelect').value;
            const monthlyData   = {};

            records.forEach(row => {
                const parts = String(row[0]).split('-');
                if (parts.length < 3) return;
                const year  = parseInt(parts[0]);
                const month = parseInt(parts[1]) - 1;
                if (selectedYear && year !== Number(selectedYear)) return;
                if (selectedMonth !== 'all' && month !== Number(selectedMonth) - 1) return;
                const key = `${year}-${month}`;
                if (!monthlyData[key]) monthlyData[key] = { credit:0, debit:0, creditBreakdown:{}, debitBreakdown:{} };
                const credit = row[4] !== "" ? Number(row[4]) : 0;
                const debit  = row[5] !== "" ? Number(row[5]) : 0;
                const label  = row[2] || row[3] || 'Unknown';
                monthlyData[key].credit += credit;
                monthlyData[key].debit  += debit;
                if (credit > 0) { if (!monthlyData[key].creditBreakdown[label]) monthlyData[key].creditBreakdown[label] = 0; monthlyData[key].creditBreakdown[label] += credit; }
                if (debit  > 0) { if (!monthlyData[key].debitBreakdown[label])  monthlyData[key].debitBreakdown[label]  = 0; monthlyData[key].debitBreakdown[label]  += debit; }
            });

            const container  = document.getElementById('monthly-container');
            container.innerHTML = '';
            const sortedKeys = Object.keys(monthlyData).sort().reverse();

            if (sortedKeys.length === 0) {
                container.innerHTML = '<div style="text-align:center; color:var(--text-sub); padding:20px;">No data available</div>';
                return;
            }

            sortedKeys.forEach(key => {
                const [year, month] = key.split('-');
                const data    = monthlyData[key];
                const savings = data.credit - data.debit;
                const section = document.createElement('div');
                section.className = 'month-section';
                section.innerHTML = `
                    <div class="month-header">${MONTH_NAMES[month]} ${year}</div>
                    <div class="month-card">
                        <table class="month-summary-table">
                            <thead><tr><th>Credit</th><th>Debit</th><th>Net</th></tr></thead>
                            <tbody><tr>
                                <td class="green">${data.credit.toLocaleString('en-US',{minimumFractionDigits:2,maximumFractionDigits:2})}</td>
                                <td class="red">${data.debit.toLocaleString('en-US',{minimumFractionDigits:2,maximumFractionDigits:2})}</td>
                                <td class="${savings>=0?'green':'red'}">${savings.toLocaleString('en-US',{minimumFractionDigits:2,maximumFractionDigits:2})}</td>
                            </tr></tbody>
                        </table>
                        <div class="month-summary-container">
                            <div class="summary-section">
                                <h4><span class="material-symbols-outlined" style="font-size:16px;">trending_up</span> Income Sources:</h4>
                                <div class="summary-list">
                                    ${Object.keys(data.creditBreakdown).length === 0
                                        ? '<div style="text-align:center; color:var(--text-muted); padding:10px;">No income sources</div>'
                                        : Object.entries(data.creditBreakdown).sort((a,b)=>b[1]-a[1]).map(([name,amount])=>`
                                            <div class="summary-item">
                                                <span><strong>${name}</strong></span>
                                                <span class="amount green">${amount.toLocaleString('en-US',{minimumFractionDigits:2,maximumFractionDigits:2})}</span>
                                            </div>`).join('')}
                                </div>
                            </div>
                            <div class="summary-section">
                                <h4><span class="material-symbols-outlined" style="font-size:16px;">trending_down</span> Expense Categories:</h4>
                                <div class="summary-list">
                                    ${Object.keys(data.debitBreakdown).length === 0
                                        ? '<div style="text-align:center; color:var(--text-muted); padding:10px;">No expenses</div>'
                                        : Object.entries(data.debitBreakdown).sort((a,b)=>b[1]-a[1]).map(([name,amount])=>`
                                            <div class="summary-item">
                                                <span><strong>${name}</strong></span>
                                                <span class="amount red">${amount.toLocaleString('en-US',{minimumFractionDigits:2,maximumFractionDigits:2})}</span>
                                            </div>`).join('')}
                                </div>
                            </div>
                        </div>
                    </div>`;
                container.appendChild(section);
            });
        }

        function renderRecentTable(records) {
            const tbody = document.getElementById('tableBody');
            tbody.innerHTML = '';
            if (!records || records.length === 0) {
                tbody.innerHTML = '<tr><td colspan="5" style="text-align:center; color:var(--text-sub);">No transactions yet</td></tr>';
                return;
            }
            records.slice(0, 50).forEach((row) => {
                const tr      = document.createElement('tr');
                const parts   = String(row[0]).split('-');
                const date    = parts.length === 3 ? `${parseInt(parts[2])}/${parseInt(parts[1])}/${parts[0]}` : row[0];
                const credit  = row[4] !== "" && row[4] !== null ? Number(row[4]) : 0;
                const debit   = row[5] !== "" && row[5] !== null ? Number(row[5]) : 0;
                const balance = row[6];
                const isCredit = credit > 0;
                tr.innerHTML = `
                    <td>${date}</td>
                    <td>
                        <div><strong>${row[2]}</strong></div>
                        <div style="font-size:12px; color:var(--text-muted);">${row[3]}</div>
                    </td>
                    <td class="amount-col ${isCredit?'green':'red'}">
                        ${isCredit?'+':'-'}${(isCredit?credit:debit).toLocaleString('en-US',{minimumFractionDigits:2})}
                    </td>
                    <td class="amount-col">${Number(balance).toLocaleString('en-US',{minimumFractionDigits:2})}</td>
                    <td class="action-col">
                        <button class="icon-btn" title="Delete">
                            <span class="material-symbols-outlined">delete</span>
                        </button>
                    </td>`;
                tr.querySelector('button.icon-btn').addEventListener('click', function() {
                    showDeleteModal(row);
                });
                tbody.appendChild(tr);
            });
        }

        function jumpToRecentTransactions() {
            document.getElementById('recent-transactions-header').scrollIntoView({ behavior:'smooth' });
        }

        // ── Delete ─────────────────────────────────────────────────────────
        function showDeleteModal(row) {
            deleteRowData = row;
            document.getElementById('deleteModal').classList.add('active');
            document.getElementById('deletePassword').value = '';
        }

        function closeDeleteModal() {
            document.getElementById('deleteModal').classList.remove('active');
            deleteRowData = null;
        }

        function confirmDelete() {
            const password = document.getElementById('deletePassword').value;
            if (password !== ADMIN_PASSWORD) { alert('Incorrect admin password!'); return; }
            if (!deleteRowData) return;
            showLoading(true, "Deleting transaction...");
            const row            = deleteRowData;
            const dateStr        = String(row[0]).trim().substring(0, 10);
            const credit         = row[4] !== "" && row[4] !== null ? Number(row[4]) : 0;
            const debit          = row[5] !== "" && row[5] !== null ? Number(row[5]) : 0;
            const amountToDelete = debit > 0 ? debit : credit;
            const typeToDelete   = debit > 0 ? "Debit" : "Credit";
            const categoryVal    = String(row[2] !== null && row[2] !== undefined ? row[2] : '').trim();
            const detailsVal     = String(row[3] !== null && row[3] !== undefined ? row[3] : '').trim();
            const params = new URLSearchParams({ op:'delete', date:dateStr, amount:amountToDelete, details:detailsVal, type:typeToDelete, category:categoryVal });
            fetch(SCRIPT_URL + "?" + params.toString())
            .then(res => res.json())
            .then(data => {
                showLoading(false);
                if (data.result === 'success') {
                    alert('Transaction deleted successfully!');
                    closeDeleteModal();
                    loadDashboardData();
                } else {
                    alert('Failed to delete:\n' + (data.error || 'Unknown error'));
                }
            })
            .catch(err => { showLoading(false); alert("Error deleting transaction: " + err); });
        }

        // ── PDF ────────────────────────────────────────────────────────────
        function showPdfModal() {
            document.getElementById('pdfModal').classList.add('active');
            updatePdfPreview();
        }
        function closePdfModal() { document.getElementById('pdfModal').classList.remove('active'); }

        function updatePdfPreview() {
            const yearEl  = document.getElementById('pdfYear');
            const monthEl = document.getElementById('pdfMonth');
            const label   = document.getElementById('pdfPreviewLabel');
            if (!yearEl || !monthEl || !label) return;
            const year  = yearEl.value;
            const month = parseInt(monthEl.value);
            if (year && month) {
                label.textContent = `${MONTH_NAMES[month - 1]} ${year}`;
            }
        }

        function generatePDF() {
            const year  = document.getElementById('pdfYear').value;
            const month = document.getElementById('pdfMonth').value;
            if (!year || !month) { alert('Please select year and month'); return; }
            showLoading(true, "Generating PDF...");

            const filtered = allRecords.filter(row => {
                const parts = String(row[0]).split('-');
                return parseInt(parts[0]) === Number(year) && parseInt(parts[1]) === Number(month);
            }).slice().sort((a, b) => String(a[0]).localeCompare(String(b[0])));

            const totalCredit = filtered.reduce((s,r) => s + (Number(r[4]) || 0), 0);
            const totalDebit  = filtered.reduce((s,r) => s + (Number(r[5]) || 0), 0);
            const netSavings  = totalCredit - totalDebit;
            const netColor    = netSavings >= 0 ? '#059669' : '#dc2626';

            const now = new Date();
            const printedDate = now.toLocaleDateString('en-US', { year: 'numeric', month: 'short', day: 'numeric' });
            const printedTime = now.toLocaleTimeString('en-US', { hour: '2-digit', minute: '2-digit' });

            const pdfDiv = document.getElementById('pdfContent');
            pdfDiv.innerHTML = `
<div style="padding:0; font-family:'Segoe UI',Arial,sans-serif; background:#f8fafd; min-height:100vh;">
  <div style="background:linear-gradient(135deg,#1a3a7c 0%,#2563eb 100%); padding:40px 48px 36px; position:relative; overflow:hidden;">
    <div style="text-align: right; color:rgba(255,255,255,0.6); font-family: Arial, sans-serif;">
        <p style="margin: 0; font-size: 11px; line-height: 1.4;">Printed: ${printedDate}<br>${printedTime}</p>
    </div>
    <div style="position:relative;z-index:1;">
      <div style="font-size:11px;font-weight:700;letter-spacing:0.14em;color:rgba(255,255,255,0.6);text-transform:uppercase;margin-bottom:8px;">Mantix_LK · Financial Statement</div>
      <div style="font-size:36px;font-weight:800;color:#ffffff;margin-bottom:6px;">Expense Report</div>
      <div style="font-size:15px;color:rgba(255,255,255,0.75);font-weight:500;">${MONTH_NAMES[month-1]} ${year}</div>
    </div>
  </div>
  <div style="padding:32px 48px 0;">
    <div style="display:grid;grid-template-columns:1fr 1fr 1fr;gap:16px;margin-bottom:32px;">
      <div style="background:#ffffff;border-radius:14px;padding:22px 20px;border:1.5px solid #e2e8f2;box-shadow:0 2px 8px rgba(26,58,124,0.07);">
        <div style="font-size:10px;font-weight:700;letter-spacing:0.1em;color:#94a3b8;text-transform:uppercase;margin-bottom:10px;">Total Credit</div>
        <div style="font-size:26px;font-weight:800;color:#059669;">${totalCredit.toLocaleString('en-US',{minimumFractionDigits:2})}</div>
        <div style="font-size:11px;color:#94a3b8;margin-top:4px;">Income this period</div>
      </div>
      <div style="background:#ffffff;border-radius:14px;padding:22px 20px;border:1.5px solid #e2e8f2;box-shadow:0 2px 8px rgba(26,58,124,0.07);">
        <div style="font-size:10px;font-weight:700;letter-spacing:0.1em;color:#94a3b8;text-transform:uppercase;margin-bottom:10px;">Total Debit</div>
        <div style="font-size:26px;font-weight:800;color:#dc2626;">${totalDebit.toLocaleString('en-US',{minimumFractionDigits:2})}</div>
        <div style="font-size:11px;color:#94a3b8;margin-top:4px;">Expenses this period</div>
      </div>
      <div style="background:#ffffff;border-radius:14px;padding:22px 20px;border:1.5px solid #e2e8f2;box-shadow:0 2px 8px rgba(26,58,124,0.07);">
        <div style="font-size:10px;font-weight:700;letter-spacing:0.1em;color:#94a3b8;text-transform:uppercase;margin-bottom:10px;">Net Savings</div>
        <div style="font-size:26px;font-weight:800;color:${netColor};">${netSavings.toLocaleString('en-US',{minimumFractionDigits:2})}</div>
        <div style="font-size:11px;color:#94a3b8;margin-top:4px;">${netSavings >= 0 ? 'Positive balance' : 'Deficit this period'}</div>
      </div>
    </div>
    <div style="display:flex;align-items:center;gap:10px;margin-bottom:14px;">
      <div style="font-size:13px;font-weight:700;color:#1a3a7c;letter-spacing:0.04em;text-transform:uppercase;">Transaction Details</div>
      <div style="flex:1;height:1.5px;background:linear-gradient(to right,#dbeafe,transparent);"></div>
      <div style="font-size:11px;color:#94a3b8;font-weight:500;">${filtered.length} records</div>
    </div>
    <div style="background:#ffffff;border-radius:14px;overflow:hidden;border:1.5px solid #e2e8f2;box-shadow:0 2px 8px rgba(26,58,124,0.06);margin-bottom:36px;">
      <table style="width:100%;border-collapse:collapse;">
        <thead>
          <tr style="background:linear-gradient(135deg,#1a3a7c,#2563eb);">
            <th style="padding:13px 16px;text-align:left;font-size:10.5px;font-weight:700;letter-spacing:0.1em;text-transform:uppercase;color:rgba(255,255,255,0.85);border:none;">#</th>
            <th style="padding:13px 16px;text-align:left;font-size:10.5px;font-weight:700;letter-spacing:0.1em;text-transform:uppercase;color:rgba(255,255,255,0.85);border:none;">Date</th>
            <th style="padding:13px 16px;text-align:left;font-size:10.5px;font-weight:700;letter-spacing:0.1em;text-transform:uppercase;color:rgba(255,255,255,0.85);border:none;">Category</th>
            <th style="padding:13px 16px;text-align:left;font-size:10.5px;font-weight:700;letter-spacing:0.1em;text-transform:uppercase;color:rgba(255,255,255,0.85);border:none;">Details</th>
            <th style="padding:13px 16px;text-align:right;font-size:10.5px;font-weight:700;letter-spacing:0.1em;text-transform:uppercase;color:rgba(255,255,255,0.85);border:none;">Amount</th>
            <th style="padding:13px 16px;text-align:right;font-size:10.5px;font-weight:700;letter-spacing:0.1em;text-transform:uppercase;color:rgba(255,255,255,0.85);border:none;">Balance</th>
          </tr>
        </thead>
        <tbody>
          ${filtered.map((row, idx) => {
              const credit = row[4] !== "" ? Number(row[4]) : 0;
              const debit  = row[5] !== "" ? Number(row[5]) : 0;
              const isCredit = credit > 0;
              const amt    = isCredit
                  ? `+${credit.toLocaleString('en-US',{minimumFractionDigits:2})}`
                  : `-${debit.toLocaleString('en-US',{minimumFractionDigits:2})}`;
              const amtColor = isCredit ? '#059669' : '#dc2626';
              const rowBg = idx % 2 === 0 ? '#ffffff' : '#f8fafd';
              return `<tr style="background:${rowBg};">
                <td style="padding:11px 16px;border-bottom:1px solid #f1f5f9;font-size:11px;color:#94a3b8;font-weight:600;">${idx+1}</td>
                <td style="padding:11px 16px;border-bottom:1px solid #f1f5f9;font-size:12px;color:#475569;font-weight:500;">${row[0]}</td>
                <td style="padding:11px 16px;border-bottom:1px solid #f1f5f9;font-size:12px;color:#1e293b;font-weight:600;">${row[2]}</td>
                <td style="padding:11px 16px;border-bottom:1px solid #f1f5f9;font-size:12px;color:#64748b;">${row[3]}</td>
                <td style="padding:11px 16px;border-bottom:1px solid #f1f5f9;text-align:right;font-size:12.5px;font-weight:700;color:${amtColor};">${amt}</td>
                <td style="padding:11px 16px;border-bottom:1px solid #f1f5f9;text-align:right;font-size:12px;color:#475569;font-weight:600;">${Number(row[6]).toLocaleString('en-US',{minimumFractionDigits:2})}</td>
              </tr>`;
          }).join('')}
        </tbody>
      </table>
    </div>
    <div style="border-top:1.5px solid #e2e8f2;padding-top:16px;padding-bottom:32px;display:flex;justify-content:space-between;align-items:center;">
      <div style="font-size:11px;color:#94a3b8;">Generated by Mantix_LK Expense Tracker</div>
      <div style="font-size:11px;color:#94a3b8;">Report Period: ${MONTH_NAMES[month-1]} ${year}</div>
    </div>
  </div>
</div>`;

            html2canvas(pdfDiv, { scale: 2, useCORS: true }).then(canvas => {
                const imgData   = canvas.toDataURL('image/png');
                const pdf       = new jspdf.jsPDF('p','mm','a4');
                const imgWidth  = 210;
                const pageHeight = 297;
                const imgHeight = canvas.height * imgWidth / canvas.width;
                let heightLeft  = imgHeight;
                let position    = 0;
                pdf.addImage(imgData,'PNG',0,position,imgWidth,imgHeight);
                heightLeft -= pageHeight;
                while (heightLeft > 0) {
                    position = heightLeft - imgHeight;
                    pdf.addPage();
                    pdf.addImage(imgData,'PNG',0,position,imgWidth,imgHeight);
                    heightLeft -= pageHeight;
                }
                pdf.save(`expense-report-${MONTH_NAMES_SHORT[month-1]}-${year}.pdf`);
                showLoading(false);
                closePdfModal();
            });
        }

        // ── Analytics ──────────────────────────────────────────────────────
        function loadAnalyticsData() {
            if (allRecords.length === 0) {
                showLoading(true, "Loading Analytics...");
                fetch(SCRIPT_URL + "?op=read")
                .then(res => res.json())
                .then(data => { showLoading(false); allRecords = data.records; initializeAnalytics(); })
                .catch(err => { showLoading(false); alert("Failed to load data: " + err); });
            } else {
                initializeAnalytics();
            }
        }

        function initializeAnalytics() {
            populateAnalyticsYearSelects();
            initializeMonthlyCheckboxes();
            initializeMonthlyChart();
            initializeYearlyCheckboxes();
            initializeYearlyChart();
        }

        function populateAnalyticsYearSelects() {
            const yearSelect        = document.getElementById('yearSelect');
            const compareYearSelect = document.getElementById('compareYearSelect');
            const years = new Set();
            allRecords.forEach(row => { years.add(parseInt(String(row[0]).substring(0,4))); });
            const sortedYears = Array.from(years).sort((a,b) => b-a);
            yearSelect.innerHTML = compareYearSelect.innerHTML = '';
            sortedYears.forEach(year => {
                const o1 = document.createElement('option'); o1.value = o1.innerText = year; yearSelect.appendChild(o1);
                const o2 = document.createElement('option'); o2.value = o2.innerText = year; compareYearSelect.appendChild(o2);
            });
            if (sortedYears.length > 0) { yearSelect.value = compareYearSelect.value = sortedYears[0]; }
            const now = new Date();
            document.getElementById('compareMonthSelect').value = now.getMonth() === 0 ? 12 : now.getMonth();
        }

        function initializeMonthlyCheckboxes() {
            const container = document.getElementById('monthlyCheckboxes');
            container.innerHTML = '';
            CATEGORIES.forEach((cat, i) => {
                const div = document.createElement('div'); div.className = 'checkbox-item';
                const cb  = document.createElement('input'); cb.type='checkbox'; cb.id='monthly-cat-'+i; cb.checked=true; cb.onchange=updateMonthlyChart;
                const lbl = document.createElement('label'); lbl.htmlFor='monthly-cat-'+i;
                lbl.innerHTML = `<span class="color-indicator" style="background:${cat.color}"></span> ${cat.name}`;
                div.appendChild(cb); div.appendChild(lbl); container.appendChild(div);
            });
        }

        function initializeMonthlyChart() { updateMonthlyChart(); }

        function updateMonthlyChart() {
            const now          = new Date();
            const currentMonth = now.getMonth();
            const currentYear  = now.getFullYear();
            const compareMonth = Number(document.getElementById('compareMonthSelect').value) - 1;
            const compareYear  = Number(document.getElementById('compareYearSelect').value);
            const curData = getCategoryTotals(currentYear, currentMonth);
            const cmpData = getCategoryTotals(compareYear, compareMonth);
            const labels=[], curVals=[], cmpVals=[], colors=[];
            CATEGORIES.forEach((cat, i) => {
                const cb = document.getElementById('monthly-cat-'+i);
                if (cb && cb.checked) {
                    labels.push(cat.name); curVals.push(curData[cat.name]||0);
                    cmpVals.push(cmpData[cat.name]||0); colors.push(cat.color);
                }
            });
            const ctx = document.getElementById('monthlyChart').getContext('2d');
            if (monthlyChart) monthlyChart.destroy();
            monthlyChart = new Chart(ctx, {
                type: 'bar',
                data: { labels, datasets: [
                    { label:'This Month', data:curVals, backgroundColor:colors, borderRadius:8, barThickness:40 },
                    { label:`${MONTH_NAMES_SHORT[compareMonth]} ${compareYear}`, data:cmpVals, backgroundColor:colors.map(c=>c+'40'), borderColor:colors, borderWidth:2, borderRadius:8, barThickness:40 }
                ]},
                options: {
                    responsive:true, maintainAspectRatio:false,
                    plugins:{ legend:{display:true,labels:{color:'#1e293b'}}, tooltip:{callbacks:{label:ctx=>ctx.dataset.label+': '+ctx.parsed.y.toLocaleString('en-US',{minimumFractionDigits:2,maximumFractionDigits:2})}} },
                    scales:{ y:{beginAtZero:true,ticks:{callback:v=>v.toLocaleString(),color:'#64748b'},grid:{color:'#e2e8f2'}}, x:{ticks:{color:'#64748b'},grid:{color:'#e2e8f2'}} }
                }
            });
        }

        function getCategoryTotals(year, month) {
            const totals = {};
            allRecords.forEach(row => {
                const parts    = String(row[0]).split('-');
                const rowYear  = parseInt(parts[0]);
                const rowMonth = parseInt(parts[1]) - 1;
                if (rowYear === year && rowMonth === month && row[5] !== "" && row[5] !== null) {
                    const amount      = Number(row[5]);
                    const rawCategory = String(row[2] || '').toLowerCase().trim();
                    let matchedCat    = 'Other';
                    for (const cat of CATEGORIES) {
                        if (cat.name === 'Other') continue;
                        if (rawCategory === cat.name.toLowerCase() || cat.keywords.some(kw => rawCategory.includes(kw))) {
                            matchedCat = cat.name; break;
                        }
                    }
                    totals[matchedCat] = (totals[matchedCat] || 0) + amount;
                }
            });
            return totals;
        }

        function initializeYearlyCheckboxes() {
            const container = document.getElementById('categoryCheckboxes');
            container.innerHTML = '';
            CATEGORIES.forEach((cat, i) => {
                const div = document.createElement('div'); div.className = 'checkbox-item';
                const cb  = document.createElement('input'); cb.type='checkbox'; cb.id='yearly-cat-'+i; cb.checked=true; cb.onchange=updateYearlyChart;
                const lbl = document.createElement('label'); lbl.htmlFor='yearly-cat-'+i;
                lbl.innerHTML = `<span class="color-indicator" style="background:${cat.color}"></span> ${cat.name}`;
                div.appendChild(cb); div.appendChild(lbl); container.appendChild(div);
            });
        }

        function initializeYearlyChart() { updateYearlyChart(); }

        function updateYearlyChart() {
            const year = Number(document.getElementById('yearSelect').value);
            const datasets = [];
            CATEGORIES.forEach((cat, i) => {
                const cb = document.getElementById('yearly-cat-'+i);
                if (cb && cb.checked) {
                    const monthlyData = [];
                    for (let m = 0; m < 12; m++) { const t = getCategoryTotals(year, m); monthlyData.push(t[cat.name]||0); }
                    datasets.push({ label:cat.name, data:monthlyData, borderColor:cat.color, backgroundColor:cat.color+'20', borderWidth:2, tension:0.3, fill:false });
                }
            });
            const ctx = document.getElementById('yearlyChart').getContext('2d');
            if (yearlyChart) yearlyChart.destroy();
            yearlyChart = new Chart(ctx, {
                type: 'line',
                data: { labels:MONTH_NAMES_SHORT, datasets },
                options: {
                    responsive:true, maintainAspectRatio:false,
                    plugins:{ legend:{display:true,labels:{color:'#1e293b'}}, tooltip:{callbacks:{label:ctx=>ctx.dataset.label+': '+ctx.parsed.y.toLocaleString('en-US',{minimumFractionDigits:2,maximumFractionDigits:2})}} },
                    scales:{ y:{beginAtZero:true,ticks:{callback:v=>v.toLocaleString(),color:'#64748b'},grid:{color:'#e2e8f2'}}, x:{ticks:{color:'#64748b'},grid:{color:'#e2e8f2'}} }
                }
            });
        }

        // ── Chat ───────────────────────────────────────────────────────────
        const chatBody  = document.getElementById('chatBody');
        const userInput = document.getElementById('userInput');
        const sendBtn   = document.getElementById('sendBtn');

        function sendChip(btn) { userInput.value = btn.textContent.trim(); sendMessage(); }
        function autoGrow(el) { el.style.height = 'auto'; el.style.height = Math.min(el.scrollHeight, 120) + 'px'; }
        function handleKey(e) { if (e.key === 'Enter' && !e.shiftKey) { e.preventDefault(); sendMessage(); } }
        function timeNow() { return new Date().toLocaleTimeString([], { hour:'2-digit', minute:'2-digit' }); }

        function removeWelcome() { const w = document.getElementById('welcomeCard'); if (w) w.remove(); }

        function appendMessage(role, content, isHtml = false) {
            removeWelcome();
            const row    = document.createElement('div'); row.className = `msg-row ${role}`;
            const av     = document.createElement('div'); av.className  = 'av';
            av.innerHTML = role === 'user' ? '<span class="material-symbols-outlined">person</span>' : '<span class="material-symbols-outlined">smart_toy</span>';
            const wrap   = document.createElement('div'); wrap.className = 'bwrap';
            const bubble = document.createElement('div'); bubble.className = 'bubble';
            if (isHtml) bubble.innerHTML = content; else bubble.textContent = content;
            const time   = document.createElement('div'); time.className = 'btime'; time.textContent = timeNow();
            wrap.appendChild(bubble); wrap.appendChild(time);
            row.appendChild(av); row.appendChild(wrap);
            chatBody.appendChild(row);
            chatBody.scrollTop = chatBody.scrollHeight;
        }

        function showTyping() {
            removeWelcome();
            const row = document.createElement('div'); row.className = 'msg-row bot'; row.id = 'typingRow';
            const av  = document.createElement('div'); av.className  = 'av';
            av.innerHTML = '<span class="material-symbols-outlined">smart_toy</span>';
            const wrap   = document.createElement('div'); wrap.className = 'bwrap';
            const bubble = document.createElement('div'); bubble.className = 'bubble';
            bubble.innerHTML = '<div class="typing"><span></span><span></span><span></span></div>';
            wrap.appendChild(bubble); row.appendChild(av); row.appendChild(wrap);
            chatBody.appendChild(row);
            chatBody.scrollTop = chatBody.scrollHeight;
        }

        function hideTyping() { const t = document.getElementById('typingRow'); if (t) t.remove(); }

        function formatReply(text) {
            let h = text.replace(/&/g,'&amp;').replace(/</g,'&lt;').replace(/>/g,'&gt;')
                .replace(/\*\*(.*?)\*\*/g, '<strong>$1</strong>')
                .replace(/`([^`]+)`/g, '<code>$1</code>');
            h = h.replace(/(?:^|\n)[*\-] (.+)/g, (_, i) => `<li>${i}</li>`);
            if (h.includes('<li>')) h = h.replace(/(<li>[\s\S]*?<\/li>)+/, m => `<ul>${m}</ul>`);
            h = h.replace(/\n/g, '<br>');
            return h;
        }

        async function sendMessage() {
            const msg = userInput.value.trim();
            if (!msg) return;
            userInput.value = ''; userInput.style.height = 'auto'; sendBtn.disabled = true;
            appendMessage('user', msg);
            showTyping();
            try {
                const res  = await fetch(`${CHAT_SCRIPT_URL}?op=chat&message=${encodeURIComponent(msg)}`);
                const data = await res.json();
                hideTyping();
                if (data.result === 'success') appendMessage('bot', formatReply(data.reply), true);
                else appendMessage('bot', 'Error: ' + (data.error || 'Something went wrong.'));
            } catch (err) {
                hideTyping();
                appendMessage('bot', 'Could not reach the server. Please try again.');
            } finally {
                sendBtn.disabled = false;
                userInput.focus();
            }
        }

        // ── Loading ────────────────────────────────────────────────────────
        function showLoading(show, text = "Processing...") {
            const el = document.getElementById('loading');
            if (show) { document.getElementById('loading-text').innerText = text; el.classList.add('active'); }
            else { el.classList.remove('active'); }
        }
    </script>
</body>
</html>