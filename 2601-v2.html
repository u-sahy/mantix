<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Expense Tracker</title>
    <link href="https://fonts.googleapis.com/css2?family=Roboto:wght@400;500;700&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://fonts.googleapis.com/css2?family=Material+Symbols+Outlined:opsz,wght,FILL,GRAD@24,400,0,0" />
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/Chart.js/3.9.1/chart.min.js"></script>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Roboto', sans-serif;
            background: #f8fafc;
            min-height: 100vh;
            padding-bottom: 80px;
            color: #334155;
        }

        /* Login Page Styles */
        #loginPage {
            display: flex;
            justify-content: center;
            align-items: center;
            min-height: 100vh;
            padding: 20px;
            background: linear-gradient(135deg, #0a192f 0%, #112240 100%);
        }

        .login-container {
            background: white;
            border-radius: 20px;
            padding: 40px;
            box-shadow: 0 10px 40px rgba(0,0,0,0.1);
            max-width: 400px;
            width: 100%;
            border: 2px solid #0a192f;
        }

        .login-container h1 {
            text-align: center;
            color: #0a192f;
            margin-bottom: 30px;
            font-size: 2rem;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 10px;
        }

        .login-form-group {
            margin-bottom: 20px;
        }

        .login-form-group label {
            display: block;
            margin-bottom: 8px;
            font-weight: 500;
            color: #475569;
        }

        .login-form-group input {
            width: 100%;
            padding: 12px;
            background: white;
            border: 2px solid #e2e8f0;
            border-radius: 8px;
            font-size: 16px;
            transition: all 0.3s ease;
            color: #334155;
        }

        .login-form-group input:focus {
            outline: none;
            border-color: #0a192f;
            box-shadow: 0 0 10px rgba(10, 25, 47, 0.1);
        }

        .btn-login {
            width: 100%;
            padding: 15px;
            background: linear-gradient(135deg, #0a192f 0%, #112240 100%);
            color: white;
            border: 2px solid #0a192f;
            border-radius: 10px;
            font-size: 18px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s ease;
        }

        .btn-login:hover {
            transform: translateY(-2px);
            box-shadow: 0 6px 20px rgba(10, 25, 47, 0.2);
            background: white;
            color: #0a192f;
        }

        .error-message {
            color: #dc2626;
            text-align: center;
            margin-top: 15px;
            display: none;
        }

        /* Main App Container */
        #appContainer {
            display: none;
            max-width: 1200px;
            margin: 0 auto;
            padding: 20px;
        }

        /* Bottom Navigation */
        .bottom-nav {
            position: fixed;
            bottom: 20px;
            left: 50%;
            transform: translateX(-50%);
            background: white;
            backdrop-filter: blur(10px);
            box-shadow: 0 8px 32px rgba(0, 0, 0, 0.1);
            display: flex;
            border-radius: 20px;
            padding: 8px;
            gap: 5px;
            z-index: 1000;
            border: 2px solid #e2e8f0;
            min-width: 300px;
            max-width: 500px;
            width: auto;
        }

        .nav-item {
            display: flex;
            flex-direction: column;
            align-items: center;
            padding: 12px 20px;
            cursor: pointer;
            transition: all 0.3s ease;
            border-radius: 15px;
            flex: 1;
            min-width: 80px;
            background: transparent;
            position: relative;
            overflow: hidden;
        }

        .nav-item:hover {
            background: rgba(10, 25, 47, 0.05);
        }

        .nav-item.active {
            background: linear-gradient(135deg, #0a192f 0%, #112240 100%);
            box-shadow: 0 4px 15px rgba(10, 25, 47, 0.1);
            transform: translateY(-2px);
        }

        .nav-item.active::before {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            height: 3px;
            background: #0a192f;
        }

        .nav-item .material-symbols-outlined {
            font-size: 24px;
            margin-bottom: 4px;
            transition: all 0.3s ease;
            color: #64748b;
        }

        .nav-item.active .material-symbols-outlined {
            color: white;
            transform: scale(1.1);
        }

        .nav-item span:not(.material-symbols-outlined) {
            font-size: 12px;
            font-weight: 500;
            transition: all 0.3s ease;
            color: #64748b;
        }

        .nav-item.active span:not(.material-symbols-outlined) {
            color: white;
            font-weight: 600;
        }

        /* Page Containers */
        .page {
            display: none;
            animation: fadeIn 0.3s ease;
        }

        .page.active {
            display: block;
        }

        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(10px); }
            to { opacity: 1; transform: translateY(0); }
        }

        .container {
            background: white;
            border-radius: 20px;
            padding: 30px;
            box-shadow: 0 10px 40px rgba(0,0,0,0.08);
            margin-top: 20px;
            border: 2px solid #e2e8f0;
        }

        .page-title {
            text-align: center;
            color: #0a192f;
            font-size: 2rem;
            margin-bottom: 30px;
            padding-bottom: 15px;
            border-bottom: 3px solid #0a192f;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 10px;
        }

        /* Form Styles */
        .form-group {
            margin-bottom: 20px;
        }

        .form-group label {
            display: block;
            margin-bottom: 8px;
            font-weight: 500;
            color: #475569;
        }

        .form-group input,
        .form-group select {
            width: 100%;
            padding: 12px;
            background: white;
            border: 2px solid #e2e8f0;
            border-radius: 8px;
            font-size: 16px;
            transition: all 0.3s ease;
            color: #334155;
        }

        .form-group input:focus,
        .form-group select:focus {
            outline: none;
            border-color: #0a192f;
            box-shadow: 0 0 10px rgba(10, 25, 47, 0.1);
        }

        .btn-submit {
            width: 100%;
            padding: 15px;
            background: linear-gradient(135deg, #0a192f 0%, #112240 100%);
            color: white;
            border: 2px solid #0a192f;
            border-radius: 10px;
            font-size: 18px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s ease;
        }

        .btn-submit:hover {
            transform: translateY(-2px);
            box-shadow: 0 6px 20px rgba(10, 25, 47, 0.2);
            background: white;
            color: #0a192f;
        }

        .btn-submit:disabled {
            opacity: 0.6;
            cursor: not-allowed;
        }

        /* Admin Unlock Section */
        .admin-unlock {
            background: #fef3c7;
            border: 2px solid #f59e0b;
            border-radius: 10px;
            padding: 20px;
            margin-bottom: 20px;
            text-align: center;
        }

        .admin-unlock h3 {
            color: #92400e;
            margin-bottom: 15px;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 10px;
        }

        .unlock-input-group {
            display: flex;
            gap: 10px;
            max-width: 400px;
            margin: 0 auto;
        }

        .unlock-input-group input {
            flex: 1;
            padding: 10px;
            background: white;
            border: 2px solid #f59e0b;
            border-radius: 8px;
            color: #334155;
        }

        .btn-unlock {
            padding: 10px 20px;
            background: #f59e0b;
            color: #92400e;
            border: 2px solid #f59e0b;
            border-radius: 8px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s ease;
        }

        .btn-unlock:hover {
            background: #92400e;
            color: white;
        }

        /* Dashboard Styles */
        .main-balance-card {
            background: linear-gradient(135deg, #0a192f 0%, #112240 100%);
            padding: 30px;
            border-radius: 15px;
            text-align: center;
            margin-bottom: 30px;
            color: white;
            position: relative;
            overflow: hidden;
        }

        .main-balance-card::before {
            content: '';
            position: absolute;
            top: -50%;
            left: -50%;
            width: 200%;
            height: 200%;
            background: linear-gradient(45deg, transparent, rgba(255, 255, 255, 0.1), transparent);
            animation: shimmer 3s infinite;
        }

        @keyframes shimmer {
            0% { transform: translateX(-100%) translateY(-100%) rotate(45deg); }
            100% { transform: translateX(100%) translateY(100%) rotate(45deg); }
        }

        .main-balance-lbl {
            font-size: 18px;
            margin-bottom: 10px;
            opacity: 0.9;
        }

        .main-balance-val {
            font-size: 48px;
            font-weight: 700;
            position: relative;
            z-index: 1;
        }

        .filter-container {
            background: #f8fafc;
            padding: 20px;
            border-radius: 10px;
            margin-bottom: 20px;
            border: 2px solid #e2e8f0;
        }

        .filter-controls {
            display: flex;
            gap: 20px;
            flex-wrap: wrap;
        }

        .filter-select-group {
            flex: 1;
            min-width: 200px;
        }

        .filter-select-group label {
            display: block;
            margin-bottom: 5px;
            font-weight: 500;
            color: #64748b;
        }

        .filter-select-group select {
            width: 100%;
            padding: 10px;
            background: white;
            border: 2px solid #e2e8f0;
            border-radius: 8px;
            font-size: 16px;
            color: #334155;
        }

        .action-icons {
            display: flex;
            gap: 10px;
        }

        .icon-btn {
            background: white;
            border: 2px solid #e2e8f0;
            padding: 8px;
            border-radius: 50%;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            transition: all 0.3s ease;
            color: #0a192f;
        }

        .icon-btn:hover {
            background: #0a192f;
            color: white;
            border-color: #0a192f;
            transform: scale(1.1);
        }

        .table-wrapper {
            overflow-x: auto;
            margin-bottom: 30px;
            border-radius: 10px;
            border: 2px solid #e2e8f0;
        }

        .recent-table {
            width: 100%;
            border-collapse: collapse;
            background: white;
        }

        .recent-table thead {
            background: #f8fafc;
        }

        .recent-table th {
            padding: 15px;
            text-align: left;
            font-weight: 600;
            color: #0a192f;
            border-bottom: 2px solid #e2e8f0;
        }

        .recent-table td {
            padding: 15px;
            border-bottom: 1px solid #e2e8f0;
            color: #475569;
        }

        .date-col {
            width: 100px;
        }

        .amount-col {
            width: 120px;
            text-align: right;
            font-weight: 500;
        }

        .action-col {
            width: 60px;
            text-align: center;
        }

        .green {
            color: #059669 !important;
        }

        .red {
            color: #dc2626 !important;
        }

        /* Monthly Breakdown */
        #monthly-container {
            margin-bottom: 30px;
        }

        .month-section {
            margin-bottom: 25px;
        }

        .month-header {
            background: linear-gradient(135deg, #0a192f 0%, #112240 100%);
            color: white;
            padding: 15px 20px;
            border-radius: 10px 10px 0 0;
            font-size: 18px;
            font-weight: 600;
            border: 2px solid #0a192f;
            border-bottom: none;
        }

        .month-card {
            background: white;
            border-radius: 0 0 10px 10px;
            overflow: hidden;
            border: 2px solid #e2e8f0;
            border-top: none;
        }

        .month-summary-table {
            width: 100%;
            border-collapse: collapse;
            background: white;
            margin: 20px;
            border-radius: 8px;
            overflow: hidden;
            border: 1px solid #e2e8f0;
        }

        .month-summary-table th {
            background: #0a192f;
            color: white;
            padding: 15px;
            text-align: center;
            font-weight: 600;
            border: 1px solid #112240;
        }

        .month-summary-table td {
            padding: 15px;
            text-align: center;
            border: 1px solid #e2e8f0;
            font-weight: 500;
            font-size: 18px;
        }

        .month-summary-table .green {
            color: #059669;
            font-weight: 700;
        }

        .month-summary-table .red {
            color: #dc2626;
            font-weight: 700;
        }

        .month-totals {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(150px, 1fr));
            gap: 15px;
            padding: 20px;
            background: #f8fafc;
        }

        .m-stat {
            text-align: center;
            padding: 15px;
            border-radius: 8px;
            background: white;
            border: 2px solid #e2e8f0;
        }

        .m-stat div {
            color: #64748b;
            margin-bottom: 8px;
            font-size: 14px;
        }

        .m-stat span {
            display: block;
            font-size: 24px;
            font-weight: 700;
            margin-top: 5px;
        }

        /* Month Summary Sections */
        .month-summary-container {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
            gap: 20px;
            margin: 20px;
        }

        .summary-section {
            background: white;
            border-radius: 10px;
            padding: 20px;
            border: 2px solid #e2e8f0;
        }

        .summary-section h4 {
            color: #0a192f;
            margin-bottom: 15px;
            font-size: 16px;
            display: flex;
            align-items: center;
            gap: 8px;
            padding-bottom: 10px;
            border-bottom: 2px solid #e2e8f0;
        }

        .summary-list {
            max-height: 200px;
            overflow-y: auto;
        }

        .summary-item {
            display: flex;
            justify-content: space-between;
            padding: 10px 0;
            border-bottom: 1px solid #f1f5f9;
        }

        .summary-item:last-child {
            border-bottom: none;
        }

        .summary-item span:first-child {
            color: #475569;
        }

        .summary-item .amount {
            font-weight: 600;
        }

        /* Analytics Styles */
        .chart-section {
            background: white;
            border-radius: 20px;
            padding: 30px;
            margin-bottom: 30px;
            border: 2px solid #e2e8f0;
        }

        .chart-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 20px;
            flex-wrap: wrap;
            gap: 15px;
        }

        .chart-header h2 {
            color: #0a192f;
            font-size: 1.8rem;
        }

        .category-checkboxes {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 15px;
            margin-bottom: 25px;
            padding: 20px;
            background: #f8fafc;
            border-radius: 10px;
            border: 2px solid #e2e8f0;
        }

        .checkbox-item {
            display: flex;
            align-items: center;
            gap: 10px;
            cursor: pointer;
            padding: 10px;
            border-radius: 8px;
            transition: background 0.3s ease;
        }

        .checkbox-item:hover {
            background: rgba(10, 25, 47, 0.05);
        }

        .checkbox-item input[type="checkbox"] {
            width: 20px;
            height: 20px;
            cursor: pointer;
            accent-color: #0a192f;
        }

        .checkbox-item label {
            cursor: pointer;
            font-weight: 500;
            color: #475569;
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .color-indicator {
            width: 15px;
            height: 15px;
            border-radius: 3px;
            display: inline-block;
        }

        .chart-container {
            position: relative;
            height: 400px;
            margin-top: 20px;
        }

        .year-selector {
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .year-selector label {
            font-weight: 500;
            color: #64748b;
        }

        .year-selector select {
            padding: 8px 15px;
            background: white;
            border: 2px solid #e2e8f0;
            border-radius: 8px;
            font-size: 16px;
            cursor: pointer;
            color: #334155;
        }

        .month-selector {
            display: flex;
            gap: 10px;
            align-items: center;
            flex-wrap: wrap;
        }

        .month-selector select,
        .month-selector input {
            padding: 8px 12px;
            background: white;
            border: 2px solid #e2e8f0;
            border-radius: 8px;
            font-size: 14px;
            color: #334155;
        }

        /* Modal Styles */
        .modal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0,0,0,0.5);
            justify-content: center;
            align-items: center;
            z-index: 9999;
        }

        .modal.active {
            display: flex;
        }

        .modal-content {
            background: white;
            padding: 30px;
            border-radius: 15px;
            max-width: 400px;
            width: 90%;
            border: 2px solid #0a192f;
            box-shadow: 0 20px 60px rgba(0,0,0,0.1);
        }

        .modal-content h3 {
            margin-bottom: 20px;
            color: #0a192f;
        }

        .modal-content p {
            color: #475569;
            margin-bottom: 15px;
        }

        .modal-buttons {
            display: flex;
            gap: 10px;
            margin-top: 20px;
        }

        .btn-primary, .btn-secondary, .btn-danger {
            flex: 1;
            padding: 12px;
            border: 2px solid;
            border-radius: 8px;
            font-size: 16px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s ease;
        }

        .btn-primary {
            background: #0a192f;
            color: white;
            border-color: #0a192f;
        }

        .btn-secondary {
            background: white;
            color: #64748b;
            border-color: #e2e8f0;
        }

        .btn-danger {
            background: #dc2626;
            color: white;
            border-color: #dc2626;
        }

        .btn-primary:hover, .btn-secondary:hover, .btn-danger:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 15px rgba(0,0,0,0.1);
        }

        .btn-primary:hover {
            background: #112240;
            border-color: #112240;
        }

        .btn-secondary:hover {
            background: #f1f5f9;
            color: #334155;
        }

        .btn-danger:hover {
            background: #b91c1c;
            border-color: #b91c1c;
        }

        /* Countdown Timer Styles */
        .countdown-container {
            background: #dc1d3a28;
            border: 2px solid #a40404;
            border-radius: 30px;
            padding: 10px 20px;
            text-align: center;
            box-shadow: 0 20px 60px rgba(0, 0, 0, 0.3);
            max-width: 500px;
            width: 100%;
            margin-bottom: 20px;
        }

        .offer-text {
            color: #666;
            font-size: 18px;
            font-weight: 500;
            margin-bottom: 10px;
        }

        .days-text {
            color: #333;
            font-size: 28px;
            font-weight: 700;
            margin-bottom: 15px;
        }

        .timer {
            color: #2d2d2d;
            font-size: 50px;
            font-weight: 700;
            letter-spacing: 8px;
            margin-bottom: 30px;
            font-variant-numeric: tabular-nums;
        }

        .choose-plan-btn {
            display: inline-block;
            background-color: #fbfbfb;
            color: rgb(49, 49, 49);
            font-size: 18px;
            font-weight: 600;
            padding: 10px 40px;
            border-radius: 50px;
            border: 2px solid #112240;
            text-decoration: none;
            cursor: pointer;
            transition: all 0.3s ease;
            box-shadow: 0 8px 20px rgba(61, 79, 143, 0.4);
        }

        .choose-plan-btn:hover {
            background-color: #112240;
            color: white;
            transform: translateY(-2px);
            box-shadow: 0 12px 30px rgba(61, 79, 143, 0.4);
        }

        .choose-plan-btn:active {
            transform: translateY(0);
        }

        /* Loading Spinner */
        #loading {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0,0,0,0.7);
            justify-content: center;
            align-items: center;
            flex-direction: column;
            z-index: 9999;
        }

        #loading.active {
            display: flex;
        }

        .spinner {
            border: 4px solid rgba(10, 25, 47, 0.3);
            border-top: 4px solid #0a192f;
            border-radius: 50%;
            width: 50px;
            height: 50px;
            animation: spin 1s linear infinite;
        }

        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }

        #loading-text {
            color: white;
            margin-top: 20px;
            font-size: 18px;
        }

        /* Logout Button */
        .logout-btn {
            position: fixed;
            top: 20px;
            right: 20px;
            background: white;
            border: 2px solid #0a192f;
            padding: 10px 20px;
            border-radius: 25px;
            cursor: pointer;
            font-size: 14px;
            display: flex;
            align-items: center;
            gap: 5px;
            box-shadow: 0 4px 15px rgba(0,0,0,0.1);
            transition: all 0.3s ease;
            z-index: 999;
            color: #0a192f;
        }

        .logout-btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 6px 20px rgba(10, 25, 47, 0.2);
            background: #0a192f;
            color: white;
        }

        /* Responsive Design */
        @media (max-width: 768px) {
            body {
                padding-bottom: 120px;
            }

            .container {
                padding: 20px;
            }

            .unlock-input-group input {
                max-width: 200px;
            }

            .main-balance-val {
                font-size: 36px;
            }

            .filter-controls {
                flex-direction: column;
            }

            .filter-select-group {
                min-width: 100%;
            }

            .month-totals, .month-summary-container {
                grid-template-columns: 1fr;
            }

            .nav-item {
                padding: 10px 12px;
                min-width: 60px;
            }

            .nav-item .material-symbols-outlined {
                font-size: 20px;
            }

            .nav-item span:not(.material-symbols-outlined) {
                font-size: 10px;
            }

            .bottom-nav {
                bottom: 10px;
                padding: 6px;
                min-width: 280px;
            }

            .chart-container {
                height: 300px;
            }

            .category-checkboxes {
                grid-template-columns: 1fr;
            }

            .logout-btn {
                padding: 8px 15px;
                font-size: 12px;
            }

            .recent-table {
                font-size: 14px;
            }

            .recent-table th,
            .recent-table td {
                padding: 10px 5px;
            }

            .month-summary-table {
                margin: 10px;
            }

            .month-summary-table td {
                padding: 10px;
                font-size: 16px;
            }
        }

        @media (max-width: 480px) {
            .page-title {
                font-size: 1.5rem;
            }

            .unlock-input-group input {
                max-width: 130px;
            }

            .main-balance-val {
                font-size: 28px;
            }

            .m-stat span {
                font-size: 18px;
            }

            .chart-container {
                height: 250px;
            }

            .bottom-nav {
                min-width: 250px;
            }

            .month-summary-table td {
                font-size: 14px;
                padding: 8px;
            }

            .timer {
                font-size: 40px;
                letter-spacing: 4px;
            }

            .choose-plan-btn {
                font-size: 15px;
                padding: 8px 20px;
            }
        }
    </style>
</head>
<body>
    <!-- Login Page -->
    <div id="loginPage">
        <div class="login-container">
            <h1>@mss2601</h1>

            <div class="countdown-container">
                <div class="offer-text">Your plan ends in</div>
                <div class="days-text"><span id="days">0</span> days</div>
                <div class="timer" id="timer">0:00:00</div>
                <a href="plans.html" class="choose-plan-btn" target="_blank">Choose a plan</a>
            </div>

            <form id="loginForm">
                <div class="login-form-group">
                    <label>Password</label>
                    <input type="password" id="loginPassword" required autocomplete="current-password">
                </div>
                <button type="submit" class="btn-login">Login</button>
                <div class="error-message" id="loginError">Invalid password</div>
            </form>

            <h1 style="margin-top: 40px; margin-bottom: 5px;">Mantix_Lk</h1>
            <p style="text-align: center;">CONTACT: <a href="mailto:info@mantixlk.com">info@mantixlk.com</a></p>
        </div>
    </div>

    <!-- Main App Container -->
    <div id="appContainer">
        <button class="logout-btn" onclick="logout()">
            <span class="material-symbols-outlined">logout</span>
            Logout
        </button>

        <!-- Entry Form Page -->
        <div id="entryPage" class="page">
            <div class="container">
                <h1 class="page-title">Entry Form</h1>
                
                <div class="admin-unlock" id="formLock">
                    <h3>ðŸ”’ Form Locked</h3>
                    <p>Enter admin password to unlock the entry form</p>
                    <div class="unlock-input-group">
                        <input type="password" id="formUnlockPassword" placeholder="Admin Password">
                        <button class="btn-unlock" onclick="unlockForm()">Unlock</button>
                    </div>
                </div>

                <form id="expenseForm" style="display:none;">
                    <div class="form-group">
                        <label>Select Date</label>
                        <input type="date" id="date" required onchange="autoSetDay()">
                    </div>
                    <div class="form-group">
                        <label>Day</label>
                        <select id="day" required>
                            <option value="MON">MON</option>
                            <option value="TUE">TUE</option>
                            <option value="WED">WED</option>
                            <option value="THU">THU</option>
                            <option value="FRI">FRI</option>
                            <option value="SAT">SAT</option>
                            <option value="SUN">SUN</option>
                        </select>
                    </div>
                    <div class="form-group">
                        <label>Category</label>
                        <input type="text" id="details" placeholder="Type Here" required>
                    </div>
                    <div class="form-group">
                        <label>Details</label>
                        <input type="text" id="location" placeholder="Type Here" required>
                    </div>
                    <div class="form-group">
                        <label>Type</label>
                        <select id="transType" required>
                            <option value="Debit">Debit (Expense)</option>
                            <option value="Credit">Credit (Income)</option>
                        </select>
                    </div>
                    <div class="form-group">
                        <label>Amount</label>
                        <input type="number" id="amount" step="0.01" placeholder="0.00" required>
                    </div>
                    <button type="submit" class="btn-submit">Submit Entry</button>
                </form>
            </div>
        </div>

        <!-- Dashboard Page -->
        <div id="dashboardPage" class="page active">
            <div class="container">
                <h1 class="page-title">Dashboard</h1>
                
                <div class="main-balance-card">
                    <div class="main-balance-lbl">Current Balance</div>
                    <div class="main-balance-val" id="d-bal">0.00</div>
                </div>
                
                <h3 style="margin-top:0; display:flex; justify-content: space-between; align-items: center;">
                    <span>Monthly Breakdown</span>
                    <span class="action-icons">
                        <button class="icon-btn" onclick="jumpToRecentTransactions()" title="Jump to History">
                            <span class="material-symbols-outlined">history</span>
                        </button>
                        <button class="icon-btn" onclick="showPdfModal()" title="Download PDF Report">
                            <span class="material-symbols-outlined">download</span>
                        </button>
                    </span>
                </h3>
                
                <div class="filter-container">
                    <div class="filter-controls">
                        <div class="filter-select-group">
                            <label for="yearFilter">Year:</label>
                            <select id="yearFilter" onchange="filterMonthlyView()">
                            </select>
                        </div>
                        <div class="filter-select-group">
                            <label for="monthSelect">Month:</label>
                            <select id="monthSelect" onchange="filterMonthlyView()">
                                <option value="all">All</option>
                            </select>
                        </div>
                    </div>
                </div>

                <div id="monthly-container">
                    <div style="text-align:center; color:#64748b; padding:20px;">Loading data...</div>
                </div>
            
                <h3 id="recent-transactions-header">Recent Transactions</h3>
                <div class="table-wrapper">
                    <table class="recent-table">
                        <thead>
                            <tr>
                                <th class="date-col">Date</th>
                                <th>Details</th>
                                <th class="amount-col">Amount</th>
                                <th class="amount-col">Balance</th>
                                <th class="action-col">Action</th>
                            </tr>
                        </thead>
                        <tbody id="tableBody">
                            <tr><td colspan="5" style="text-align:center; color:#64748b;">Loading...</td></tr>
                        </tbody>
                    </table>
                </div>
            </div>
        </div>

        <!-- Analytics Page -->
        <div id="analyticsPage" class="page">
            <div class="container">
                <h1 class="page-title">Analytics</h1>

                <!-- Monthly Comparison Section -->
                <div class="chart-section">
                    <div class="chart-header">
                        <h2>Monthly Comparison</h2>
                        <div class="month-selector">
                            <label>Compare with:</label>
                            <select id="compareMonthSelect" onchange="updateMonthlyChart()">
                                <option value="1">January</option>
                                <option value="2">February</option>
                                <option value="3">March</option>
                                <option value="4">April</option>
                                <option value="5">May</option>
                                <option value="6">June</option>
                                <option value="7">July</option>
                                <option value="8">August</option>
                                <option value="9">September</option>
                                <option value="10">October</option>
                                <option value="11">November</option>
                                <option value="12">December</option>
                            </select>
                            <select id="compareYearSelect" onchange="updateMonthlyChart()">
                            </select>
                        </div>
                    </div>
                    
                    <div class="category-checkboxes" id="monthlyCheckboxes">
                    </div>

                    <div class="chart-container">
                        <canvas id="monthlyChart"></canvas>
                    </div>
                </div>

                <!-- Yearly Trends Section -->
                <div class="chart-section">
                    <div class="chart-header">
                        <h2>Yearly Trends</h2>
                        <div class="year-selector">
                            <label for="yearSelect">Year:</label>
                            <select id="yearSelect" onchange="updateYearlyChart()">
                            </select>
                        </div>
                    </div>
                    
                    <div class="category-checkboxes" id="categoryCheckboxes">
                    </div>

                    <div class="chart-container">
                        <canvas id="yearlyChart"></canvas>
                    </div>
                </div>
            </div>
        </div>

        <!-- Bottom Navigation -->
        <div class="bottom-nav">
            <div class="nav-item" onclick="switchPage('entry')">
                <span class="material-symbols-outlined">forms_add_on</span>
                <span>Form</span>
            </div>
            <div class="nav-item active" onclick="switchPage('dashboard')">
                <span class="material-symbols-outlined">tile_medium</span>
                <span>Dashboard</span>
            </div>
            <div class="nav-item" onclick="switchPage('analytics')">
                <span class="material-symbols-outlined">monitoring</span>
                <span>Analytics</span>
            </div>
        </div>
    </div>

    <!-- Delete Modal -->
    <div id="deleteModal" class="modal">
        <div class="modal-content">
            <h3>Delete Transaction</h3>
            <p>Enter admin password to confirm deletion:</p>
            <div class="form-group">
                <input type="password" id="deletePassword" placeholder="Admin Password">
            </div>
            <div class="modal-buttons">
                <button class="btn-danger" onclick="confirmDelete()">Delete</button>
                <button class="btn-secondary" onclick="closeDeleteModal()">Cancel</button>
            </div>
        </div>
    </div>

    <!-- PDF Modal -->
    <div id="pdfModal" class="modal">
        <div class="modal-content">
            <h3>Generate PDF Report</h3>
            <div class="form-group">
                <label for="pdfYear">Select Year</label>
                <select id="pdfYear" required></select>
            </div>
            <div class="form-group">
                <label for="pdfMonth">Select Month</label>
                <select id="pdfMonth" required>
                    <option value="1">January</option>
                    <option value="2">February</option>
                    <option value="3">March</option>
                    <option value="4">April</option>
                    <option value="5">May</option>
                    <option value="6">June</option>
                    <option value="7">July</option>
                    <option value="8">August</option>
                    <option value="9">September</option>
                    <option value="10">October</option>
                    <option value="11">November</option>
                    <option value="12">December</option>
                </select>
            </div>
            <div class="modal-buttons">
                <button class="btn-primary" onclick="generatePDF()">Download</button>
                <button class="btn-secondary" onclick="closePdfModal()">Cancel</button>
            </div>
        </div>
    </div>

    <!-- Loading Spinner -->
    <div id="loading">
        <div class="spinner"></div>
        <div id="loading-text">Processing...</div>
    </div>

    <div id="pdfContent" style="position:absolute;left:-9999px;"></div>

    <script>
        // ============================================================
        // Configuration
        // ============================================================
        const SCRIPT_URL = "https://script.google.com/macros/s/AKfycbz7qYrCA__-oMhqfY4KwkXZ81Rlfl4qWuVguPb3Z9bKflZOAHWIfp8TtjB1II-ivUplEQ/exec";
        const LOGIN_PASSWORD = "Pm26";
        const ADMIN_PASSWORD = "admin26";
        const MONTH_NAMES = ['January','February','March','April','May','June','July','August','September','October','November','December'];
        const MONTH_NAMES_SHORT = ['Jan','Feb','Mar','Apr','May','Jun','Jul','Aug','Sep','Oct','Nov','Dec'];

        const CATEGORIES = [
            { name: 'Rent',          color: '#9F7AEA', keywords: ['hostel','rent','reservation','accommodation'] },
            { name: 'Current Usage', color: '#FFD700', keywords: ['current','electricity','power','electric bill','eb'] },
            { name: 'Water Usage',   color: '#00B5D8', keywords: ['water','water bill','aqua'] },
            { name: 'Grocery',       color: '#48BB78', keywords: ['grocery','supermarket','market','vegetables','fruits','food items'] },
            { name: 'Reload',        color: '#E53E3E', keywords: ['reload','topup','recharge','mobile','data'] },
            { name: 'Other',         color: '#FF46D2', keywords: [] }
        ];

        let allRecords = [];
        let monthlyChart = null;
        let yearlyChart = null;
        let formUnlocked = false;
        let deleteRowIndex = null;

        // ============================================================
        // SAFE DATE FORMATTER
        // Avoids UTC timezone shift. Works with Date objects or strings.
        // ============================================================
        function safeFormatDate(rawDate) {
            if (!rawDate) return '';
            if (typeof rawDate === 'string') {
                return rawDate.trim().substring(0, 10);
            }
            const d = new Date(rawDate);
            if (isNaN(d.getTime())) return rawDate.toString().substring(0, 10);
            const yyyy = d.getFullYear();
            const mm   = String(d.getMonth() + 1).padStart(2, '0');
            const dd   = String(d.getDate()).padStart(2, '0');
            return `${yyyy}-${mm}-${dd}`;
        }

        // ============================================================
        // SAFE NUMBER PARSER
        // Handles null, undefined, empty string, and numeric values.
        // ============================================================
        function safeParseFloat(val) {
            if (val === null || val === undefined || val === '') return 0;
            const parsed = parseFloat(val);
            return isNaN(parsed) ? 0 : parsed;
        }

        // ============================================================
        // Login
        // ============================================================
        document.getElementById('loginForm').addEventListener('submit', function(e) {
            e.preventDefault();
            const password = document.getElementById('loginPassword').value;
            if (password === LOGIN_PASSWORD) {
                document.getElementById('loginPage').style.display = 'none';
                document.getElementById('appContainer').style.display = 'block';
                loadDashboardData();
            } else {
                document.getElementById('loginError').style.display = 'block';
            }
        });

        function logout() {
            if (confirm('Are you sure you want to logout?')) {
                window.location.href = 'https://mantixlk.com';
            }
        }

        // ============================================================
        // Page Switcher
        // ============================================================
        function switchPage(page) {
            document.querySelectorAll('.page').forEach(p => p.classList.remove('active'));
            document.querySelectorAll('.nav-item').forEach(n => n.classList.remove('active'));

            if (page === 'entry') {
                document.getElementById('entryPage').classList.add('active');
                document.querySelectorAll('.nav-item')[0].classList.add('active');
                checkFormLock();
            } else if (page === 'dashboard') {
                document.getElementById('dashboardPage').classList.add('active');
                document.querySelectorAll('.nav-item')[1].classList.add('active');
                loadDashboardData();
            } else if (page === 'analytics') {
                document.getElementById('analyticsPage').classList.add('active');
                document.querySelectorAll('.nav-item')[2].classList.add('active');
                loadAnalyticsData();
            }
        }

        // ============================================================
        // Form Lock / Unlock
        // ============================================================
        function checkFormLock() {
            if (formUnlocked) {
                document.getElementById('formLock').style.display = 'none';
                document.getElementById('expenseForm').style.display = 'block';
            } else {
                document.getElementById('formLock').style.display = 'block';
                document.getElementById('expenseForm').style.display = 'none';
            }
        }

        function unlockForm() {
            const password = document.getElementById('formUnlockPassword').value;
            if (password === ADMIN_PASSWORD) {
                formUnlocked = true;
                checkFormLock();
                document.getElementById('date').valueAsDate = new Date();
                autoSetDay();
            } else {
                alert('Incorrect admin password!');
            }
        }

        function autoSetDay() {
            const d = document.getElementById('date').value;
            if (!d) return;
            const days = ['SUN','MON','TUE','WED','THU','FRI','SAT'];
            document.getElementById('day').value = days[new Date(d).getDay()];
        }

        // ============================================================
        // Form Submit
        // ============================================================
        document.getElementById('expenseForm').addEventListener('submit', function(e) {
            e.preventDefault();
            showLoading(true, "Saving...");

            const params = new URLSearchParams({
                op: 'submit',
                date: document.getElementById('date').value,
                day: document.getElementById('day').value,
                location: document.getElementById('location').value,
                details: document.getElementById('details').value,
                type: document.getElementById('transType').value,
                amount: document.getElementById('amount').value
            });

            fetch(SCRIPT_URL + "?" + params.toString())
            .then(res => res.json())
            .then(data => {
                showLoading(false);
                alert("Submitted Successfully!");
                document.getElementById('expenseForm').reset();
                document.getElementById('date').valueAsDate = new Date();
                autoSetDay();
            })
            .catch(err => {
                showLoading(false);
                alert("Error: " + err);
            });
        });

        // ============================================================
        // Dashboard
        // ============================================================
        function loadDashboardData() {
            showLoading(true, "Loading Dashboard...");
            fetch(SCRIPT_URL + "?op=read")
            .then(res => res.json())
            .then(data => {
                showLoading(false);
                allRecords = data.records;
                displayDashboard(data);
            })
            .catch(err => {
                showLoading(false);
                alert("Failed to load data: " + err);
            });
        }

        function displayDashboard(data) {
            const balance = data.summary.bal || 0;
            document.getElementById('d-bal').innerText = balance.toLocaleString('en-US', {minimumFractionDigits: 2, maximumFractionDigits: 2});
            populateYearFilter();
            renderMonthly(data.records);
            renderRecentTable(data.records);
        }

        function populateYearFilter() {
            const yearFilter = document.getElementById('yearFilter');
            const pdfYear    = document.getElementById('pdfYear');
            const years      = new Set();

            allRecords.forEach(row => {
                const year = new Date(row[0]).getFullYear();
                years.add(year);
            });

            const sortedYears = Array.from(years).sort((a, b) => b - a);
            yearFilter.innerHTML = '';
            pdfYear.innerHTML = '';

            sortedYears.forEach(year => {
                const opt1 = document.createElement('option');
                opt1.value = year; opt1.innerText = year;
                yearFilter.appendChild(opt1);

                const opt2 = document.createElement('option');
                opt2.value = year; opt2.innerText = year;
                pdfYear.appendChild(opt2);
            });

            if (sortedYears.length > 0) {
                yearFilter.value = sortedYears[0];
                document.getElementById('monthSelect').innerHTML =
                    '<option value="all">All</option>' +
                    Array.from({length: 12}, (_, i) =>
                        `<option value="${i+1}">${MONTH_NAMES_SHORT[i]}</option>`
                    ).join('');
            }
        }

        function filterMonthlyView() {
            renderMonthly(allRecords);
        }

        function renderMonthly(records) {
            const selectedYear  = document.getElementById('yearFilter').value;
            const selectedMonth = document.getElementById('monthSelect').value;
            const monthlyData   = {};

            records.forEach(row => {
                const dateObj = new Date(row[0]);
                const year    = dateObj.getFullYear();
                const month   = dateObj.getMonth();

                if (selectedYear && year !== Number(selectedYear)) return;
                if (selectedMonth !== 'all' && month !== Number(selectedMonth) - 1) return;

                const key = `${year}-${month}`;
                if (!monthlyData[key]) {
                    monthlyData[key] = { credit: 0, debit: 0, creditBreakdown: {}, debitBreakdown: {} };
                }

                const credit  = safeParseFloat(row[4]);
                const debit   = safeParseFloat(row[5]);
                const details = row[3];

                monthlyData[key].credit += credit;
                monthlyData[key].debit  += debit;

                if (credit > 0) {
                    monthlyData[key].creditBreakdown[details] = (monthlyData[key].creditBreakdown[details] || 0) + credit;
                }
                if (debit > 0) {
                    monthlyData[key].debitBreakdown[details] = (monthlyData[key].debitBreakdown[details] || 0) + debit;
                }
            });

            const container  = document.getElementById('monthly-container');
            container.innerHTML = '';
            const sortedKeys = Object.keys(monthlyData).sort().reverse();

            if (sortedKeys.length === 0) {
                container.innerHTML = '<div style="text-align:center; color:#64748b; padding:20px;">No data available</div>';
                return;
            }

            sortedKeys.forEach(key => {
                const [year, month] = key.split('-');
                const data    = monthlyData[key];
                const savings = data.credit - data.debit;
                const section = document.createElement('div');
                section.className = 'month-section';

                section.innerHTML = `
                    <div class="month-header">${MONTH_NAMES[month]} ${year}</div>
                    <div class="month-card">
                        <table class="month-summary-table">
                            <thead>
                                <tr>
                                    <th>Credit</th>
                                    <th>Debit</th>
                                    <th>Net</th>
                                </tr>
                            </thead>
                            <tbody>
                                <tr>
                                    <td class="green">${data.credit.toLocaleString('en-US', {minimumFractionDigits:2, maximumFractionDigits:2})}</td>
                                    <td class="red">${data.debit.toLocaleString('en-US', {minimumFractionDigits:2, maximumFractionDigits:2})}</td>
                                    <td class="${savings >= 0 ? 'green' : 'red'}">${savings.toLocaleString('en-US', {minimumFractionDigits:2, maximumFractionDigits:2})}</td>
                                </tr>
                            </tbody>
                        </table>
                        <div class="month-summary-container">
                            <div class="summary-section">
                                <h4><span class="material-symbols-outlined">trending_up</span> Income Sources:</h4>
                                <div class="summary-list">
                                    ${Object.keys(data.creditBreakdown).length === 0
                                        ? '<div style="text-align:center;color:#64748b;padding:10px;">No income sources</div>'
                                        : Object.entries(data.creditBreakdown)
                                            .sort((a,b) => b[1]-a[1])
                                            .map(([name,amount]) => `
                                                <div class="summary-item">
                                                    <span><strong>${name}</strong></span>
                                                    <span class="amount green">${amount.toLocaleString('en-US',{minimumFractionDigits:2,maximumFractionDigits:2})}</span>
                                                </div>`).join('')
                                    }
                                </div>
                            </div>
                            <div class="summary-section">
                                <h4><span class="material-symbols-outlined">trending_down</span> Expense Categories:</h4>
                                <div class="summary-list">
                                    ${Object.keys(data.debitBreakdown).length === 0
                                        ? '<div style="text-align:center;color:#64748b;padding:10px;">No expenses</div>'
                                        : Object.entries(data.debitBreakdown)
                                            .sort((a,b) => b[1]-a[1])
                                            .map(([name,amount]) => `
                                                <div class="summary-item">
                                                    <span><strong>${name}</strong></span>
                                                    <span class="amount red">${amount.toLocaleString('en-US',{minimumFractionDigits:2,maximumFractionDigits:2})}</span>
                                                </div>`).join('')
                                    }
                                </div>
                            </div>
                        </div>
                    </div>`;

                container.appendChild(section);
            });
        }

        function renderRecentTable(records) {
            const tbody = document.getElementById('tableBody');
            tbody.innerHTML = '';

            if (records.length === 0) {
                tbody.innerHTML = '<tr><td colspan="5" style="text-align:center;color:#64748b;">No transactions yet</td></tr>';
                return;
            }

            records.slice(0, 50).forEach((row, index) => {
                const tr          = document.createElement('tr');
                const displayDate = safeFormatDate(row[0]);
                const credit      = safeParseFloat(row[4]);
                const debit       = safeParseFloat(row[5]);
                const balance     = row[6];
                const isCredit    = credit > 0;

                tr.innerHTML = `
                    <td>${displayDate}</td>
                    <td>
                        <div><strong>${row[3]}</strong></div>
                        <div style="font-size:12px;color:#64748b;">${row[2]}</div>
                    </td>
                    <td class="amount-col ${isCredit ? 'green' : 'red'}">
                        ${isCredit ? '+' : '-'}${(isCredit ? credit : debit).toLocaleString('en-US', {minimumFractionDigits:2})}
                    </td>
                    <td class="amount-col">${Number(balance).toLocaleString('en-US', {minimumFractionDigits:2})}</td>
                    <td class="action-col">
                        <button class="icon-btn" onclick="showDeleteModal(${index})" title="Delete">
                            <span class="material-symbols-outlined">delete</span>
                        </button>
                    </td>`;

                tbody.appendChild(tr);
            });
        }

        function jumpToRecentTransactions() {
            document.getElementById('recent-transactions-header').scrollIntoView({ behavior: 'smooth' });
        }

        // ============================================================
        // DELETE â€” FIXED
        // Uses safeParseFloat so amount is never 0 when it shouldn't be.
        // Removed debug alert.
        // ============================================================
        function showDeleteModal(index) {
            deleteRowIndex = index;
            document.getElementById('deleteModal').classList.add('active');
            document.getElementById('deletePassword').value = '';
        }

        function closeDeleteModal() {
            document.getElementById('deleteModal').classList.remove('active');
            deleteRowIndex = null;
        }

        function confirmDelete() {
            const password = document.getElementById('deletePassword').value;

            if (password !== ADMIN_PASSWORD) {
                alert('Incorrect admin password!');
                return;
            }

            if (deleteRowIndex === null) return;

            const rowToDelete = allRecords[deleteRowIndex];
            const dateToDelete = safeFormatDate(rowToDelete[0]);

            // â”€â”€ FIX: Use safeParseFloat to robustly read credit/debit â”€â”€
            const credit = safeParseFloat(rowToDelete[4]);
            const debit  = safeParseFloat(rowToDelete[5]);
            const amountToDelete = debit > 0 ? debit : credit;
            const typeToDelete   = debit > 0 ? "Debit" : "Credit";
            // â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€

            // Safety guard â€” prevent sending amount=0 to backend
            if (amountToDelete === 0) {
                alert(
                    'Could not read the transaction amount.\n\n' +
                    'Raw credit value: [' + rowToDelete[4] + ']\n' +
                    'Raw debit value:  [' + rowToDelete[5] + ']\n\n' +
                    'Please refresh and try again.'
                );
                return;
            }

            showLoading(true, "Deleting transaction...");

            const params = new URLSearchParams({
                op:       'delete',
                date:     dateToDelete,
                amount:   amountToDelete,
                details:  rowToDelete[3],
                type:     typeToDelete,
                location: rowToDelete[2]
            });

            fetch(SCRIPT_URL + "?" + params.toString())
            .then(res => res.json())
            .then(data => {
                showLoading(false);
                if (data.result === 'success') {
                    alert('Transaction deleted successfully!');
                    closeDeleteModal();
                    loadDashboardData();
                } else {
                    alert('Failed to delete transaction: ' + (data.error || 'Unknown error'));
                }
            })
            .catch(err => {
                showLoading(false);
                alert("Error deleting transaction: " + err);
            });
        }

        // ============================================================
        // PDF
        // ============================================================
        function showPdfModal() {
            document.getElementById('pdfModal').classList.add('active');
        }

        function closePdfModal() {
            document.getElementById('pdfModal').classList.remove('active');
        }

        function generatePDF() {
            const year  = document.getElementById('pdfYear').value;
            const month = document.getElementById('pdfMonth').value;

            if (!year || !month) { alert('Please select year and month'); return; }

            showLoading(true, "Generating PDF...");

            const filtered = allRecords.filter(row => {
                const d = new Date(row[0]);
                return d.getFullYear() === Number(year) && d.getMonth() === Number(month) - 1;
            });

            const pdfDiv = document.getElementById('pdfContent');
            pdfDiv.innerHTML = `
                <div style="padding:20px; font-family:Arial, sans-serif;">
                    <h1 style="text-align:center; color:#0a192f; margin-bottom:10px;">Expense Report</h1>
                    <h3 style="text-align:center; color:#475569; margin-bottom:30px; border-bottom:2px solid #e2e8f0; padding-bottom:10px;">${MONTH_NAMES[month-1]} ${year}</h3>
                    <table style="width:100%; border-collapse:collapse; margin-bottom:30px; border:2px solid #0a192f;">
                        <thead>
                            <tr style="background:#0a192f; color:white;">
                                <th style="padding:12px; text-align:center; border:1px solid #112240;">Credit</th>
                                <th style="padding:12px; text-align:center; border:1px solid #112240;">Debit</th>
                                <th style="padding:12px; text-align:center; border:1px solid #112240;">Net</th>
                            </tr>
                        </thead>
                        <tbody>
                            <tr>
                                <td style="padding:12px; text-align:center; border:1px solid #e2e8f0; color:#059669; font-weight:bold;">
                                    ${filtered.reduce((sum, row) => sum + safeParseFloat(row[4]), 0).toLocaleString('en-US', {minimumFractionDigits:2})}
                                </td>
                                <td style="padding:12px; text-align:center; border:1px solid #e2e8f0; color:#dc2626; font-weight:bold;">
                                    ${filtered.reduce((sum, row) => sum + safeParseFloat(row[5]), 0).toLocaleString('en-US', {minimumFractionDigits:2})}
                                </td>
                                <td style="padding:12px; text-align:center; border:1px solid #e2e8f0; font-weight:bold;">
                                    ${(filtered.reduce((sum, row) => sum + safeParseFloat(row[4]), 0) -
                                       filtered.reduce((sum, row) => sum + safeParseFloat(row[5]), 0)
                                      ).toLocaleString('en-US', {minimumFractionDigits:2})}
                                </td>
                            </tr>
                        </tbody>
                    </table>
                    <table style="width:100%; border-collapse:collapse; margin-top:20px;">
                        <thead>
                            <tr style="background:#f8fafc;">
                                <th style="border:1px solid #e2e8f0; padding:10px; text-align:left;">Date</th>
                                <th style="border:1px solid #e2e8f0; padding:10px; text-align:left;">Category</th>
                                <th style="border:1px solid #e2e8f0; padding:10px; text-align:left;">Details</th>
                                <th style="border:1px solid #e2e8f0; padding:10px; text-align:right;">Amount</th>
                                <th style="border:1px solid #e2e8f0; padding:10px; text-align:right;">Balance</th>
                            </tr>
                        </thead>
                        <tbody>
                            ${filtered.map(row => {
                                const credit = safeParseFloat(row[4]);
                                const debit  = safeParseFloat(row[5]);
                                const amt    = credit > 0
                                    ? `+${credit.toLocaleString('en-US', {minimumFractionDigits:2})}`
                                    : `-${debit.toLocaleString('en-US', {minimumFractionDigits:2})}`;
                                const color  = credit > 0 ? '#059669' : '#dc2626';
                                return `
                                    <tr>
                                        <td style="border:1px solid #e2e8f0; padding:8px;">${safeFormatDate(row[0])}</td>
                                        <td style="border:1px solid #e2e8f0; padding:8px;">${row[3]}</td>
                                        <td style="border:1px solid #e2e8f0; padding:8px;">${row[2]}</td>
                                        <td style="border:1px solid #e2e8f0; padding:8px; text-align:right; color:${color}; font-weight:500;">${amt}</td>
                                        <td style="border:1px solid #e2e8f0; padding:8px; text-align:right; font-weight:500;">${Number(row[6]).toLocaleString('en-US', {minimumFractionDigits:2})}</td>
                                    </tr>`;
                            }).join('')}
                        </tbody>
                    </table>
                </div>`;

            html2canvas(pdfDiv).then(canvas => {
                const imgData   = canvas.toDataURL('image/png');
                const pdf       = new jspdf.jsPDF('p', 'mm', 'a4');
                const imgWidth  = 210;
                const imgHeight = canvas.height * imgWidth / canvas.width;
                pdf.addImage(imgData, 'PNG', 0, 0, imgWidth, imgHeight);
                pdf.save(`expense-report-${MONTH_NAMES_SHORT[month-1]}-${year}.pdf`);
                showLoading(false);
                closePdfModal();
            });
        }

        // ============================================================
        // Analytics
        // ============================================================
        function loadAnalyticsData() {
            if (allRecords.length === 0) {
                showLoading(true, "Loading Analytics...");
                fetch(SCRIPT_URL + "?op=read")
                .then(res => res.json())
                .then(data => {
                    showLoading(false);
                    allRecords = data.records;
                    initializeAnalytics();
                })
                .catch(err => {
                    showLoading(false);
                    alert("Failed to load data: " + err);
                });
            } else {
                initializeAnalytics();
            }
        }

        function initializeAnalytics() {
            populateAnalyticsYearSelects();
            initializeMonthlyCheckboxes();
            initializeMonthlyChart();
            initializeYearlyCheckboxes();
            initializeYearlyChart();
        }

        function populateAnalyticsYearSelects() {
            const yearSelect        = document.getElementById('yearSelect');
            const compareYearSelect = document.getElementById('compareYearSelect');
            const years             = new Set();

            allRecords.forEach(row => years.add(new Date(row[0]).getFullYear()));

            const sortedYears = Array.from(years).sort((a,b) => b-a);
            yearSelect.innerHTML        = '';
            compareYearSelect.innerHTML = '';

            sortedYears.forEach(year => {
                const o1 = document.createElement('option'); o1.value = year; o1.innerText = year;
                yearSelect.appendChild(o1);
                const o2 = document.createElement('option'); o2.value = year; o2.innerText = year;
                compareYearSelect.appendChild(o2);
            });

            if (sortedYears.length > 0) {
                yearSelect.value        = sortedYears[0];
                compareYearSelect.value = sortedYears[0];
            }

            const prevMonth = new Date().getMonth() === 0 ? 12 : new Date().getMonth();
            document.getElementById('compareMonthSelect').value = prevMonth;
        }

        function categorizeTransaction(details) {
            const lower = details.toLowerCase();
            for (let cat of CATEGORIES) {
                if (cat.name === 'Other') continue;
                for (let kw of cat.keywords) {
                    if (lower.includes(kw)) return cat.name;
                }
            }
            return 'Other';
        }

        function initializeMonthlyCheckboxes() {
            const container = document.getElementById('monthlyCheckboxes');
            container.innerHTML = '';
            CATEGORIES.forEach((cat, i) => {
                const div      = document.createElement('div'); div.className = 'checkbox-item';
                const checkbox = document.createElement('input');
                checkbox.type = 'checkbox'; checkbox.id = 'monthly-cat-' + i;
                checkbox.checked = true; checkbox.onchange = updateMonthlyChart;
                const label = document.createElement('label');
                label.htmlFor = 'monthly-cat-' + i;
                label.innerHTML = `<span class="color-indicator" style="background:${cat.color}"></span> ${cat.name}`;
                div.appendChild(checkbox); div.appendChild(label);
                container.appendChild(div);
            });
        }

        function initializeMonthlyChart() { updateMonthlyChart(); }

        function updateMonthlyChart() {
            const now          = new Date();
            const compareMonth = Number(document.getElementById('compareMonthSelect').value) - 1;
            const compareYear  = Number(document.getElementById('compareYearSelect').value);
            const curMonthData = getCategoryTotals(now.getFullYear(), now.getMonth());
            const cmpMonthData = getCategoryTotals(compareYear, compareMonth);

            const labels = [], currentValues = [], compareValues = [], colors = [];
            CATEGORIES.forEach((cat, i) => {
                const cb = document.getElementById('monthly-cat-' + i);
                if (cb && cb.checked) {
                    labels.push(cat.name);
                    currentValues.push(curMonthData[cat.name] || 0);
                    compareValues.push(cmpMonthData[cat.name] || 0);
                    colors.push(cat.color);
                }
            });

            const ctx = document.getElementById('monthlyChart').getContext('2d');
            if (monthlyChart) monthlyChart.destroy();

            monthlyChart = new Chart(ctx, {
                type: 'bar',
                data: {
                    labels,
                    datasets: [
                        { label: 'This Month', data: currentValues, backgroundColor: colors, borderRadius: 8, barThickness: 40 },
                        { label: `${MONTH_NAMES_SHORT[compareMonth]} ${compareYear}`, data: compareValues, backgroundColor: colors.map(c=>c+'40'), borderColor: colors, borderWidth: 2, borderRadius: 8, barThickness: 40 }
                    ]
                },
                options: {
                    responsive: true, maintainAspectRatio: false,
                    plugins: {
                        legend: { display: true, labels: { color: '#334155' } },
                        tooltip: { callbacks: { label: ctx => ctx.dataset.label + ': ' + ctx.parsed.y.toLocaleString('en-US', {minimumFractionDigits:2}) } }
                    },
                    scales: {
                        y: { beginAtZero: true, ticks: { callback: v => v.toLocaleString(), color: '#64748b' }, grid: { color: '#e2e8f0' } },
                        x: { ticks: { color: '#64748b' }, grid: { color: '#e2e8f0' } }
                    }
                }
            });
        }

        function getCategoryTotals(year, month) {
            const totals = {};
            allRecords.forEach(row => {
                const d = new Date(row[0]);
                if (d.getFullYear() === year && d.getMonth() === month) {
                    const debit = safeParseFloat(row[5]);
                    if (debit > 0) {
                        const cat = categorizeTransaction(row[3]);
                        totals[cat] = (totals[cat] || 0) + debit;
                    }
                }
            });
            return totals;
        }

        function initializeYearlyCheckboxes() {
            const container = document.getElementById('categoryCheckboxes');
            container.innerHTML = '';
            CATEGORIES.forEach((cat, i) => {
                const div      = document.createElement('div'); div.className = 'checkbox-item';
                const checkbox = document.createElement('input');
                checkbox.type = 'checkbox'; checkbox.id = 'yearly-cat-' + i;
                checkbox.checked = true; checkbox.onchange = updateYearlyChart;
                const label = document.createElement('label');
                label.htmlFor = 'yearly-cat-' + i;
                label.innerHTML = `<span class="color-indicator" style="background:${cat.color}"></span> ${cat.name}`;
                div.appendChild(checkbox); div.appendChild(label);
                container.appendChild(div);
            });
        }

        function initializeYearlyChart() { updateYearlyChart(); }

        function updateYearlyChart() {
            const year     = Number(document.getElementById('yearSelect').value);
            const datasets = [];

            CATEGORIES.forEach((cat, i) => {
                const cb = document.getElementById('yearly-cat-' + i);
                if (cb && cb.checked) {
                    const monthlyData = [];
                    for (let m = 0; m < 12; m++) {
                        const totals = getCategoryTotals(year, m);
                        monthlyData.push(totals[cat.name] || 0);
                    }
                    datasets.push({
                        label: cat.name, data: monthlyData,
                        borderColor: cat.color, backgroundColor: cat.color + '20',
                        borderWidth: 2, tension: 0.3, fill: false
                    });
                }
            });

            const ctx = document.getElementById('yearlyChart').getContext('2d');
            if (yearlyChart) yearlyChart.destroy();

            yearlyChart = new Chart(ctx, {
                type: 'line',
                data: { labels: MONTH_NAMES_SHORT, datasets },
                options: {
                    responsive: true, maintainAspectRatio: false,
                    plugins: {
                        legend: { display: true, labels: { color: '#334155' } },
                        tooltip: { callbacks: { label: ctx => ctx.dataset.label + ': ' + ctx.parsed.y.toLocaleString('en-US', {minimumFractionDigits:2}) } }
                    },
                    scales: {
                        y: { beginAtZero: true, ticks: { callback: v => v.toLocaleString(), color: '#64748b' }, grid: { color: '#e2e8f0' } },
                        x: { ticks: { color: '#64748b' }, grid: { color: '#e2e8f0' } }
                    }
                }
            });
        }

        // ============================================================
        // Countdown Timer
        // ============================================================
        function updateCountdown() {
            const targetDate = new Date('2026-02-28T23:59:59').getTime();
            const now        = new Date().getTime();
            const difference = targetDate - now;

            if (difference > 0) {
                const days    = Math.floor(difference / (1000 * 60 * 60 * 24));
                const hours   = Math.floor((difference % (1000 * 60 * 60 * 24)) / (1000 * 60 * 60));
                const minutes = Math.floor((difference % (1000 * 60 * 60)) / (1000 * 60));
                const seconds = Math.floor((difference % (1000 * 60)) / 1000);
                document.getElementById('days').textContent  = days;
                document.getElementById('timer').textContent = `${hours}:${minutes.toString().padStart(2,'0')}:${seconds.toString().padStart(2,'0')}`;
            } else {
                document.getElementById('days').textContent  = '0';
                document.getElementById('timer').textContent = '0:00:00';
            }
        }

        updateCountdown();
        setInterval(updateCountdown, 1000);

        // ============================================================
        // Loading Spinner
        // ============================================================
        function showLoading(show, text = "Processing...") {
            const el = document.getElementById('loading');
            if (show) {
                document.getElementById('loading-text').innerText = text;
                el.classList.add('active');
            } else {
                el.classList.remove('active');
            }
        }
    </script>
</body>
</html>